<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>bonkaim</title>
<style>
  :root{
    --bg:#f6f6f6; --brand:#ffd400; --ink:#222; --muted:#666;
    --c-date:#ffe7a1; --c-count:#e3f0ff; --c-price:#e9ffe7; --c-total:#ffe9d7;
    --c-haraj:#ffdbe4; --c-worker:#e8f0ff; --c-net:#e7ffe7;
    --c-actions:#fff; --radius:14px;
  }
  html,body{background:#fff;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Tahoma,Arial,sans-serif;color:var(--ink)}
  .topbar{position:sticky;top:0;z-index:5;background:var(--brand);border-bottom:3px solid #00000020}
  .wrap{max-width:980px;margin:0 auto;padding:8px 12px}
  h1{margin:0;font-weight:700;font-size:22px;display:flex;align-items:center;gap:10px}
  .badge{background:#000;color:#fff;border-radius:8px;padding:2px 8px;font-weight:700}
  .tools{display:flex;gap:10px;margin:10px 0 0}
  .btn{border:2px solid #0003;background:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .note{font-size:13px;color:var(--muted);margin:10px 0;text-align:center}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center;margin-top:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input[type="number"], .field input[type="date"], .field input[type="text"]{
    border:2px solid #0001;border-radius:10px;padding:10px 12px;font-size:16px
  }
  .pill{display:inline-block;background:#000;color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .tbl{margin-top:14px;border:2px solid #0002;border-radius:var(--radius);overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 8px;border-left:2px solid #0001;border-top:2px solid #0001;text-align:center}
  th:first-child,td:first-child{border-right:none}
  tr:first-child th{border-top:none}
  thead th{font-size:14px}
  thead th:nth-child(1){background:var(--c-date)}
  thead th:nth-child(2){background:var(--c-count)}
  thead th:nth-child(3){background:var(--c-price)}
  thead th:nth-child(4){background:var(--c-total)}
  thead th:nth-child(5){background:var(--c-haraj)}
  thead th:nth-child(6){background:var(--c-worker)}
  thead th:nth-child(7){background:var(--c-net)}
  thead th:nth-child(8), thead th:nth-child(9){background:#f5fff5}
  thead th:nth-child(10){background:var(--c-actions)}
  tbody td:nth-child(1){background:var(--c-date)}
  tfoot td{font-weight:800;background:#f7f7f7}
  .ok{background:#2ecc71;border:2px solid #1f8f4f;color:#fff;border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer}
  .no{background:#ff6b6b;border:2px solid #c03;color:#fff;border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer}
  .del{background:#000;color:#fff;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .chip{font-size:12px;line-height:1.2}
  .hint{font-size:12px;color:#888}
  dialog{border:none;border-radius:14px;padding:16px 14px;max-width:480px}
</style>
</head>
<body>

<div class="topbar">
  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <h1>bonkaim <span class="badge">B</span></h1>
      <div class="tools">
        <button class="btn" id="btnSync">تحديث من الشيت</button>
        <button class="btn" id="btnClear">مسح المحلي</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- رسالة حالة -->
  <div id="status" class="hint">فشل الرفع… محفوظ محلياً.</div>

  <!-- النموذج -->
  <div class="form" style="margin-top:14px">
    <div class="field">
      <label>التاريخ</label>
      <input type="date" id="inDate">
    </div>
    <div class="field">
      <label>عدد الثنين</label>
      <input type="number" id="inCount" placeholder="مثال: 100">
    </div>
    <div class="field">
      <label>حراج (مدفوع؟)</label>
      <input type="checkbox" id="inHarajPaid" />
    </div>
    <div class="field">
      <label>سعر الثنين (ريال)</label>
      <input type="number" id="inPrice" placeholder="مثال: 25">
    </div>
    <div class="field">
      <label class="hint">أجرة عامل (مدفوعة؟)</label>
      <input type="checkbox" id="inWorkerPaid" checked>
    </div>
    <div class="field" style="align-self:end">
      <button id="btnAdd" class="pill">إضافة +</button>
    </div>
  </div>

  <div class="note">.Google Sheets مع يتزامن + يحفظ مجاناً — الحراج = 1% — الأجرة = 2 ريال × عدد الثنين</div>

  <!-- الجدول -->
  <div class="tbl">
    <table id="tbl">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>عدد الثنين</th>
          <th>سعر الثنين</th>
          <th>الإجمالي</th>
          <th>حراج 1%</th>
          <th>أجر العامل (2/ثنين)</th>
          <th>صافي الربح</th>
          <th>أجرة عامل</th>
          <th>حراج</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <td class="chip">يحفظ تلقائياً<br/>+ مزامنة بالشيت</td>
          <td id="sumCount">0</td>
          <td><span id="avgPrice">0.00</span> (متوسط)</td>
          <td id="sumTotal">0.00</td>
          <td id="sumHaraj">0.00</td>
          <td id="sumWorker">0.00</td>
          <td id="sumNet">0.00</td>
          <td></td><td></td><td>الإجماليات</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- حوار تنبيه -->
<dialog id="dlg">
  <div id="dlgText" style="margin-bottom:10px"></div>
  <button onclick="dlg.close()">إغلاق</button>
</dialog>

<script>
/* ===== إعداداتك ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbyBlKn5FVFJm0FMp98ntQ8E3y9Ae_AlRzchLlXUEFcAcD32xW4nSFjRTgf9K5-PeynyoQ/exec"; // رابط السكربت المنشور (النسخة الأخيرة)
const HEADERS = ['id','date','count','price','total','fee','worker','net','harajPaid','workerPaid'];
/* ==================== */

const $ = sel => document.querySelector(sel);
const rowsEl = $("#rows");
const dlg = $("#dlg"), dlgText=$("#dlgText");
const stateKey = "bonkaim-data-v2";
const queueKey = "bonkaim-queue-v2";
let data = load(stateKey) || [];      // السجلات المحلية
let queue = load(queueKey) || [];     // عمليات تنتظر الرفع
updateUI();

/* أحداث */
$("#btnAdd").onclick = addRow;
$("#btnSync").onclick = syncFromSheet;
$("#btnClear").onclick = clearLocal;

/* افتراض تاريخ اليوم */
$("#inDate").value = new Date().toISOString().slice(0,10);

/* أدوات مساعدة */
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ try{ return JSON.parse(localStorage.getItem(k)) }catch{ return null } }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function money(n){ return (+n||0).toFixed(2); }
function show(msg){ dlgText.textContent = msg; dlg.showModal(); }
function setStatus(msg){ $("#status").textContent = msg; }

/* حسابات الصف */
function compute(r){
  const count = +r.count||0;
  const price = +r.price||0;
  const total = count*price;
  const fee = total*0.01;
  const worker = count*2;
  const net = total - fee - worker;
  return {...r,total,fee,worker,net};
}

/* رسم الجدول + المجاميع */
function updateUI(){
  rowsEl.innerHTML = "";
  let sumCount=0,sumTotal=0,sumFee=0,sumWorker=0,sumNet=0;
  let priceSum=0, priceN=0;

  data.forEach(r=>{
    r = compute(r);
    sumCount += (+r.count||0);
    sumTotal += r.total; sumFee += r.fee; sumWorker += r.worker; sumNet += r.net;
    if(+r.price){ priceSum+=+r.price; priceN++; }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.count||0}</td>
      <td>${money(r.price)}</td>
      <td>${money(r.total)}</td>
      <td>${money(r.fee)}</td>
      <td>${money(r.worker)}</td>
      <td>${money(r.net)}</td>
      <td><button class="ok" title="أجرة عامل مدفوعة">${r.workerPaid==='TRUE'?'✓':' '}</button></td>
      <td><button class="ok" title="حراج مدفوع">${r.harajPaid==='TRUE'?'✓':' '}</button></td>
      <td><button class="del">حذف</button></td>
    `;
    tr.querySelector(".del").onclick = ()=> removeRow(r.id);
    rowsEl.appendChild(tr);
  });

  $("#sumCount").textContent = sumCount;
  $("#sumTotal").textContent = money(sumTotal);
  $("#sumHaraj").textContent = money(sumFee);
  $("#sumWorker").textContent = money(sumWorker);
  $("#sumNet").textContent = money(sumNet);
  $("#avgPrice").textContent = money(priceN?priceSum/priceN:0);

  // حالة
  if(queue.length>0){
    setStatus("بانتظار الرفع ⌛ — السجلات محفوظة محلياً.");
    tryFlushQueue(); // حاول الرفع بصمت
  }else{
    setStatus("تم التحديث من الشيت ✓");
  }

  save(stateKey,data);
  save(queueKey,queue);
}

/* إضافة */
function addRow(){
  const r = {
    id: uid(),
    date: $("#inDate").value,
    count: $("#inCount").value,
    price: $("#inPrice").value,
    harajPaid: $("#inHarajPaid").checked ? 'TRUE':'FALSE',
    workerPaid: $("#inWorkerPaid").checked ? 'TRUE':'FALSE',
  };
  data.push(r);
  queue.push({op:'add', row:r});
  updateUI();
}

/* حذف */
function removeRow(id){
  data = data.filter(r=>r.id!==id);
  queue.push({op:'delete', id});
  updateUI();
}

/* مسح المحلي فقط */
function clearLocal(){
  if(!confirm("متأكد تمسح البيانات المحلية فقط؟")) return;
  data = []; queue = [];
  updateUI();
}

/* تزامن من الشيت (سحب من الشيت) */
async function syncFromSheet(){
  try{
    const u = new URL(API_URL);
    u.searchParams.set('action','get');
    const res = await fetch(u, {method:'GET'});
    const json = await res.json();
    if(json.ok){
      const rows = json.data || [];
      // تأكد من المفاتيح والتحويل لأسماءنا
      data = rows.map(arr=>{
        const o={}; HEADERS.forEach((h,i)=>o[h]=arr[i] ?? '');
        return o;
      });
      // بعد السحب حاول ترفَع أي طوابير عالقة
      await tryFlushQueue(true);
      updateUI();
    }else{
      show("تعذر التحديث من الشيت.");
    }
  }catch(e){
    show("تعذر التحديث من الشيت. الشبكة؟");
  }
}

/* رفع الطوابير (إضافة/حذف) */
async function tryFlushQueue(force=false){
  if(queue.length===0) return;
  // جرّب واحدة واحدة؛ إذا فشلت وقف بهدوء
  const item = queue[0];
  try{
    const form = new URLSearchParams();
    form.set('action', item.op==='delete'?'delete':'add');
    if(item.op==='delete'){
      form.set('id', item.id);
    }else{
      // طبّق الحِسابات قبل الإرسال (اختياري)
      const r = compute(item.row);
      HEADERS.forEach(h=> form.set(h, r[h] ?? ''));
    }
    const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:form.toString()});
    const json = await res.json();
    if(json.ok){
      queue.shift(); // تم
      save(queueKey,queue);
      if(force) setStatus("تم التحديث من الشيت ✓");
      // جرّب التالية
      if(queue.length>0) tryFlushQueue(force);
    }else{
      // فشل هادئ
      setStatus("فشل الرفع الآن، السجل محفوظ محلياً.");
    }
  }catch(err){
    setStatus("فشل الرفع الآن، السجل محفوظ محلياً.");
  }
}

/* عند التحميل الأول: جرّب ترفَع أي شيء متبقّي */
window.addEventListener('load', ()=> { if(queue.length>0) tryFlushQueue(); });
</script>
</body>
</html>
