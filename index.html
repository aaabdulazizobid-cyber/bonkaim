<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>برنامج بيع البونيكام — متزامن مع Google Sheets</title>
<meta name="theme-color" content="#FFD700">
<style>
  :root{
    --bg:#f8f9fb; --card:#fff; --ink:#111;
    --muted:#666; --brand:#ffd700; --brand-d:#e0c200;
    --green:#c6efce; --red:#ffc7ce; --yellow:#fff2cc; --blue:#ddebf7;
    --lightgreen:#e2efda; --orange:#fce4d6; --pink:#ead1dc; --steel:#d9e1f2; --net:#c6e0b4;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic","Helvetica Neue",Arial,sans-serif;line-height:1.5}
  header{background:var(--brand);border-bottom:1px solid var(--brand-d);padding:12px 16px;font-weight:800;text-align:center;border-radius:0 0 12px 12px}
  .wrap{max-width:1200px;margin:auto;padding:16px}
  .card{background:var(--card);border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:12px}
  .form{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px;align-items:end}
  label{font-size:13px;color:#555;display:block;margin-bottom:6px}
  input[type="date"],input[type="number"]{width:100%;padding:12px 10px;font-size:16px;border:1.5px solid #bbb;border-radius:10px;background:#fff}
  input[type="checkbox"]{width:22px;height:22px}
  button{padding:12px 14px;font-size:15px;border:1px solid #222;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#fff;color:#111}
  .hint{font-size:12px;color:#666;margin-top:6px}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#fff}
  .ok{background:#eaffea;border-color:#a4d7a4}
  .bad{background:#ffecec;border-color:#efb1b1}
  .table-wrap{margin-top:12px;background:var(--card);border:1px solid #000;border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#fafafa;z-index:1;border-bottom:2px solid #000;font-size:14px;padding:12px;text-align:center}
  tbody td{padding:10px 8px;border-bottom:1px solid #000;border-top:1px solid #000;border-right:1px solid #000}
  tbody tr:nth-child(even){background:#fcfcfc}
  tfoot td{padding:12px 8px;font-weight:bold;border-top:3px solid #000;background:#f0f0f0}
  .center{text-align:center}
  .num{font-variant-numeric:tabular-nums}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600}
  .paid{background:var(--green)} .unpaid{background:var(--red)}
  .cell-date{background:var(--yellow)} .cell-count{background:var(--blue)}
  .cell-price{background:var(--lightgreen)} .cell-total{background:var(--orange)}
  .cell-fee{background:var(--pink)} .cell-worker{background:var(--steel)}
  .cell-net{background:var(--net)}
  .del-btn{background:#fff;color:#b00020;border:1px solid #ffd6d6;border-radius:8px;padding:6px 10px;cursor:pointer}
  .row-actions{display:flex;gap:6px;justify-content:center}
  @media (max-width:900px){.form{grid-template-columns:1fr 1fr;gap:8px}}
</style>
</head>
<body>
<header>برنامج بيع البونيكام — متزامن مع Google Sheets</header>
<div class="wrap">

  <div class="card">
    <div class="bar">
      <span id="conn" class="pill">يتحقق من الاتصال…</span>
      <button type="button" class="secondary" id="btnPull">تحديث من الشيت</button>
      <button type="button" class="secondary" id="btnFlush">مسح المحلي</button>
    </div>
  </div>

  <!-- النموذج -->
  <div class="card">
    <form id="entryForm" class="form">
      <div>
        <label>التاريخ</label>
        <input type="date" id="date" required>
      </div>
      <div>
        <label>عدد الفلين</label>
        <input type="number" id="count" inputmode="numeric" min="0" step="1" placeholder="مثال: 100">
      </div>
      <div>
        <label>سعر الفلين (ريال)</label>
        <input type="number" id="price" inputmode="decimal" min="0" step="0.01" placeholder="مثال: 25">
      </div>
      <div class="center">
        <label for="harajPaid" style="margin-bottom:6px">دفع الحراج</label>
        <input type="checkbox" id="harajPaid">
      </div>
      <div class="center">
        <label for="workerPaid" style="margin-bottom:6px">دفع أجرة العامل</label>
        <input type="checkbox" id="workerPaid">
      </div>
      <div class="center">
        <button type="submit">+ إضافة</button>
      </div>
    </form>
    <div class="hint">الأجرة = <b>2 ريال</b> × عدد الفلين — الحراج = <b>1%</b> من الإجمالي. يحفظ تلقائيًا محليًا ويزامن مع Google Sheets.</div>
  </div>

  <!-- الجدول -->
  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>إجراء</th>
          <th>رسوم حراج</th>
          <th class="cell-net">صافي الربح</th>
          <th class="cell-worker">أجرة العامل (2/فلين)</th>
          <th class="cell-fee">حراج 1%</th>
          <th class="cell-total">الإجمالي</th>
          <th class="cell-price">سعر الفلين</th>
          <th class="cell-count">عدد الفلين</th>
          <th class="cell-date">التاريخ</th>
          <th>حالة الأجرة</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>الإجماليات</td>
          <td></td>
          <td id="tNet" class="num center">0.00</td>
          <td id="tWorker" class="num center">0.00</td>
          <td id="tFee" class="num center">0.00</td>
          <td id="tTotal" class="num center">0.00</td>
          <td id="tAvgPrice" class="num center">0.00 (متوسط)</td>
          <td id="tCount" class="num center">0</td>
          <td></td>
          <td class="center" style="font-size:12px">يحفظ تلقائيًا</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ================= إعدادات NoCodeAPI ================= */
const NOCODE_BASE = 'https://v1.nocodeapi.com/bonkaim/google_sheets/MpBntOqzeXdxSGmZ';
const SHEET_TAB   = 'الورقة1';

/* ================= حالة التطبيق المحلية ================= */
const LS_KEY = 'bonikam_sync_v1';
let entries = [];          // البيانات المحلية المعروضة
let pending = [];          // صفوف فشلت مزامنتها (نحاول لاحقًا)

/* ================= مساعدين عامّين ================= */
function todayISO(){
  const d = new Date();
  const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return tz.toISOString().slice(0,10);
}
function loadAll(){
  const o = JSON.parse(localStorage.getItem(LS_KEY) || '{"entries":[],"pending":[]}');
  entries = Array.isArray(o.entries)?o.entries:[];
  pending = Array.isArray(o.pending)?o.pending:[];
}
function saveAll(){
  localStorage.setItem(LS_KEY, JSON.stringify({entries,pending}));
}
function compute(e){
  const count = Number(e.count)||0, price = Number(e.price)||0;
  const total = count * price;
  const fee = +(total * 0.01).toFixed(2);
  const worker = +(count * 2).toFixed(2);
  const net = +(total - fee - worker).toFixed(2);
  e.total = +total.toFixed(2); e.fee = fee; e.worker = worker; e.net = net;
  return e;
}
function badge(ok){ return ok ? '<span class="badge paid">تم الدفع</span>' : '<span class="badge unpaid">لم يتم الدفع</span>'; }

/* ================= اتصال NoCodeAPI ================= */
async function httpJson(url, options={}) {
  const res = await fetch(url, {
    method: options.method || 'GET',
    headers: { 'Content-Type': 'application/json', ...(options.headers||{}) },
    body: options.body ? JSON.stringify(options.body) : undefined,
  });
  if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
  return res.json();
}
async function pushToSheet(entry){ // POST JSON objects
  const url = `${NOCODE_BASE}?tabId=${encodeURIComponent(SHEET_TAB)}`;
  return httpJson(url, { method:'POST', body: { data:[entry] } });
}
async function pullFromSheet(){   // GET rows
  const qs = new URLSearchParams({ tabId:SHEET_TAB, perPage:'1000', page:'1' });
  const url = `${NOCODE_BASE}?${qs.toString()}`;
  const out = await httpJson(url);
  return out.data || [];
}

/* ================= العرض ================= */
function render(){
  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  // رتب حسب التاريخ
  entries.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  for(const e of entries){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="row-actions"><button class="del-btn" data-id="${e.id}">حذف</button></td>
      <td class="center">${badge(!!e.harajPaid)}</td>
      <td class="cell-net num center">${(e.net??0).toFixed(2)}</td>
      <td class="cell-worker num center">${(e.worker??0).toFixed(2)}</td>
      <td class="cell-fee num center">${(e.fee??0).toFixed(2)}</td>
      <td class="cell-total num center">${(e.total??0).toFixed(2)}</td>
      <td class="cell-price num center">${e.price??0}</td>
      <td class="cell-count num center">${e.count??0}</td>
      <td class="cell-date center">${e.date||''}</td>
      <td class="center">${badge(!!e.workerPaid)}</td>
    `;
    tr.querySelector('.del-btn').onclick = ()=>{ removeLocal(e.id); };
    tbody.appendChild(tr);
  }
  const sum = k=>entries.reduce((a,c)=>a+Number(c[k]||0),0);
  const priceAvg = entries.filter(e=>e.price>0).length ? (sum('price')/entries.filter(e=>e.price>0).length) : 0;
  document.getElementById('tCount').textContent  = sum('count').toFixed(0);
  document.getElementById('tTotal').textContent  = sum('total').toFixed(2);
  document.getElementById('tFee').textContent    = sum('fee').toFixed(2);
  document.getElementById('tWorker').textContent = sum('worker').toFixed(2);
  document.getElementById('tNet').textContent    = sum('net').toFixed(2);
  document.getElementById('tAvgPrice').textContent = priceAvg.toFixed(2)+' (متوسط)';
}

/* ================= عمليات محلية ================= */
function addLocal(e){ entries.push(e); saveAll(); render(); }
function removeLocal(id){ entries = entries.filter(x=>x.id!==id); saveAll(); render(); }

/* ================= واجهات الأزرار ================= */
async function onAddSubmit(ev){
  ev.preventDefault();
  const date   = (document.getElementById('date').value)||todayISO();
  const count  = Number(document.getElementById('count').value||0);
  const price  = Number(document.getElementById('price').value||0);
  const harajPaid  = document.getElementById('harajPaid').checked;
  const workerPaid = document.getElementById('workerPaid').checked;
  const row = compute({ id:Date.now().toString(), date, count, price, harajPaid, workerPaid });
  addLocal(row);

  // جرّب الإرسال للشيت
  try {
    await pushToSheet(row);
    setConn(true, 'متصل بـ Google Sheets');
  } catch(e){
    pending.push(row); saveAll();
    setConn(false, 'تعذّر الإرسال الآن (سيتكرر لاحقًا)');
    alert('تعذّر الإرسال للشيت الآن، السطر محفوظ محليًا وسيعاد إرساله عند التحديث.');
  }

  document.getElementById('count').value='';
  document.getElementById('price').value='';
}

async function onPull(){
  try{
    // حاول إرسال المعلّق أولًا
    if(pending.length){
      const cp = [...pending]; pending = [];
      for(const r of cp){
        try{ await pushToSheet(r); } catch{ pending.push(r); }
      }
      saveAll();
    }
    const rows = await pullFromSheet();
    // نتوقع أن رؤوس الأعمدة مطابقة مفاتيحنا — لو في سلاسل TRUE/FALSE نحولها
    const norm = rows.map(r=>({
      id: String(r.id||r.ID||r.Id||r.row_id||Date.now()),
      date: r.date||'',
      count: Number(r.count||0),
      price: Number(r.price||0),
      total: Number(r.total||0),
      fee: Number(r.fee||0),
      worker: Number(r.worker||0),
      net: Number(r.net||0),
      harajPaid: (r.harajPaid===true || r.harajPaid==="TRUE"),
      workerPaid:(r.workerPaid===true|| r.workerPaid==="TRUE"),
    }));
    entries = norm; saveAll(); render();
    setConn(true,'تم التحديث من الشيت');
  }catch(e){
    console.error(e);
    setConn(false,'تعذّر الجلب من الشيت');
    alert('تعذّر الجلب من الشيت.\n'+(e.message||e));
  }
}
function onFlush(){
  if(confirm('متأكد تبي تمسح كل البيانات المحلية؟')){
    entries=[]; pending=[]; saveAll(); render();
  }
}

/* ================= حالة الاتصال ================= */
function setConn(ok,msg){
  const t = document.getElementById('conn');
  t.textContent = msg || (ok?'متصل بـ Google Sheets':'غير متصل');
  t.className = 'pill ' + (ok?'ok':'bad');
}

/* ================= تشغيل أولي ================= */
document.getElementById('date').value = todayISO();
document.getElementById('entryForm').addEventListener('submit', onAddSubmit);
document.getElementById('btnPull').addEventListener('click', onPull);
document.getElementById('btnFlush').addEventListener('click', onFlush);

loadAll(); render();
setConn(true,'جاهز');

</script>
</body>
</html>
