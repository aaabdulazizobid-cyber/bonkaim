<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>bonkaim</title>
<style>
:root{
  --brand:#ffd200; --ink:#111; --muted:#666;
  --c-date:#ffe08a;       /* التاريخ */
  --c-count:#e7f4ff;      /* عدد الثنين */
  --c-price:#e6ffe6;      /* سعر الثنين */
  --c-total:#fff1dc;      /* الإجمالي */
  --c-fee:#ffe0ea;        /* حراج 1% */
  --c-worker:#eaf0ff;     /* أجر العامل (2/ثنين) */
  --c-net:#eaffea;        /* صافي الربح */
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:var(--ink)}
.topbar{position:sticky;top:0;z-index:10;background:var(--brand);padding:10px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #e6c700}
.btn{border:0;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
.btn.gray{background:#fff;border:2px solid #000;color:#000}
.brand{margin-inline-start:auto;display:flex;align-items:center;gap:8px;font-weight:900}
.badge{background:#000;color:#fff;padding:2px 7px;border-radius:10px}
.wrap{max-width:1100px;margin:12px auto;padding:0 12px}
.row3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:10px}
.row2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:10px}
label{font-size:13px;color:#444;margin:6px 2px;display:block}
input[type="number"],input[type="date"],input[type="text"]{width:100%;height:40px;border:2px solid #ddd;border-radius:10px;padding:0 12px;font-size:16px;background:#fff}
.switch{display:flex;align-items:center;gap:8px}
.addline{display:flex;align-items:center;gap:10px;margin:14px 0}
.btn.black{background:#000;color:#fff}
.note{font-size:12px;color:#555;margin:6px 2px}
.table{overflow:auto;border-radius:14px;border:2px solid #ddd;background:#fff}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px}
th,td{padding:10px 12px;border-bottom:1px solid #eee;text-align:center;font-weight:700}
thead th{position:sticky;top:0;background:#fff}
.col-date{background:var(--c-date)}
.col-count{background:var(--c-count)}
.col-price{background:var(--c-price)}
.col-total{background:var(--c-total)}
.col-fee{background:var(--c-fee)}
.col-worker{background:var(--c-worker)}
.col-net{background:var(--c-net)}
.ok{background:#12c063;color:#fff;padding:2px 8px;border-radius:8px;font-weight:900}
.x{background:#ff3b30;color:#fff;padding:2px 8px;border-radius:8px;font-weight:900}
.del{background:#000;color:#fff;border:0;border-radius:8px;padding:6px 12px;cursor:pointer}
tfoot td{font-weight:900;background:#f7f7f7}
.small{font-size:12px;color:#666}
</style>
</head>
<body>

<!-- الشريط العلوي -->
<div class="topbar">
  <button id="btnVersion" class="btn gray">تراجع النسخة</button>
  <button id="btnClear" class="btn gray">مسح المحلي</button>
  <button id="btnPull"  class="btn gray">تحديث من الشيت</button>
  <div class="brand"><span class="badge">B</span> bonkaim</div>
</div>

<div class="wrap">
  <!-- المدخلات -->
  <div class="row3">
    <div>
      <label>عدد الثنين</label>
      <input id="inpCount" type="number" inputmode="numeric" placeholder="مثال: 100">
    </div>
    <div>
      <label>سعر الثنين (ريال)</label>
      <input id="inpPrice" type="number" step="0.01" inputmode="decimal" placeholder="مثال: 25">
    </div>
    <div>
      <label>التاريخ</label>
      <input id="inpDate" type="date">
    </div>
  </div>

  <div class="row2">
    <label class="switch"><input id="chkHarajPaid" type="checkbox"> حراج (مدفوع؟)</label>
    <label class="switch"><input id="chkWorkerPaid" type="checkbox" checked> أجرة عامل (مدفوعة؟)</label>
  </div>

  <div class="addline">
    <button id="btnAdd" class="btn black">+ إضافة</button>
    <span id="state" class="small">جارِ الرفع عند توفر الشبكة…</span>
  </div>

  <div class="note">.Google Sheets مع يتزامن + يحفظ محليًا — %1 = الحراج — الثنين عدد × 2 ريال = الأجرة</div>

  <!-- الجدول -->
  <div class="table">
    <table id="tbl">
      <thead>
        <tr>
          <th class="col-date">التاريخ</th>
          <th class="col-count">عدد الثنين</th>
          <th class="col-price">سعر الثنين</th>
          <th class="col-total">الإجمالي</th>
          <th class="col-fee">حراج 1%</th>
          <th class="col-worker">أجر العامل (2/ثنين)</th>
          <th class="col-net">صافي الربح</th>
          <th>أجرة عامل</th>
          <th>حراج</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
      <tfoot>
        <tr>
          <td class="small">يحفظ تلقائيًا<br>+ مزامنة بالشيت</td>
          <td id="fCount">0</td>
          <td id="fPriceAvg">0.00 (متوسط)</td>
          <td id="fTotal">0.00</td>
          <td id="fFee">0.00</td>
          <td id="fWorker">0.00</td>
          <td id="fNet">0.00</td>
          <td id="fWorkerPaid">—</td>
          <td id="fHarajPaid">—</td>
          <td>الإجماليات</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ================== إعدادات ================== */
const APP_VERSION='9';              // لو تغيّر التصميم/الكاش زِد الرقم
const API_URL = 'https://script.google.com/macros/s/AKfycbyBlKn5FVFJm0FMp98ntQ8E3y9Ae_AlRzchLlXUEFcAcD32xW4nSFjRTgf9K5-PeynyoQ/exec';
const STORAGE_KEY='bk_rows';
const PENDING_KEY='bk_pending';

const $=s=>document.querySelector(s);
const fmt=n=>Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
const today=()=>new Date().toISOString().slice(0,10);
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

function getRows(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}}
function setRows(v){localStorage.setItem(STORAGE_KEY,JSON.stringify(v))}
function getPend(){try{return JSON.parse(localStorage.getItem(PENDING_KEY)||'[]')}catch{return[]}}
function setPend(v){localStorage.setItem(PENDING_KEY,JSON.stringify(v))}
function bust(u){const x=new URL(u);x.searchParams.set('_',Date.now());return x.toString()}

const _fetch=window.fetch.bind(window);
window.fetch=(i,o={})=>{
  let url=(typeof i==='string')?i:i.url;
  if(url?.startsWith(API_URL)){url=bust(url);o=Object.assign({cache:'no-store',keepalive:true},o||{});return _fetch(url,o)}
  return _fetch(i,o);
};

/* ======== حسابات السطر ======== */
function calc(r){
  const count=+r.count||0, price=+r.price||0;
  const total=count*price, fee=total*0.01, worker=count*2, net=total-fee-worker;
  return {...r,total,fee,worker,net};
}

/* ======== رسم الجدول ======== */
function render(){
  const body=$('#body'); body.innerHTML='';
  const rows=getRows().map(calc);

  let sCount=0, sPrice=0, sTotal=0, sFee=0, sWorker=0, sNet=0, cHarajPaid=0, cWorkerPaid=0;

  rows.forEach(r=>{
    sCount+=+r.count||0;
    sPrice+=(+r.price||0)*(+r.count||0);
    sTotal+=r.total; sFee+=r.fee; sWorker+=r.worker; sNet+=r.net;
    if(r.harajPaid) cHarajPaid++; if(r.workerPaid) cWorkerPaid++;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="col-date">${r.date||''}</td>
      <td class="col-count">${r.count||0}</td>
      <td class="col-price">${fmt(r.price||0)}</td>
      <td class="col-total">${fmt(r.total)}</td>
      <td class="col-fee">${fmt(r.fee)}</td>
      <td class="col-worker">${fmt(r.worker)}</td>
      <td class="col-net">${fmt(r.net)}</td>
      <td>${r.workerPaid?'<span class="ok">✓</span>':'<span class="x">✕</span>'}</td>
      <td>${r.harajPaid?'<span class="ok">✓</span>':'<span class="x">✕</span>'}</td>
      <td><button class="del" data-del="${r.id}">حذف</button></td>`;
    body.appendChild(tr);
  });

  $('#fCount').textContent=sCount;
  $('#fPriceAvg').textContent=sCount?fmt(sPrice/sCount)+' (متوسط)':'0.00 (متوسط)';
  $('#fTotal').textContent=fmt(sTotal);
  $('#fFee').textContent=fmt(sFee);
  $('#fWorker').textContent=fmt(sWorker);
  $('#fNet').textContent=fmt(sNet);
  $('#fWorkerPaid').textContent=cWorkerPaid?cWorkerPaid:'—';
  $('#fHarajPaid').textContent=cHarajPaid?cHarajPaid:'—';
}

/* ======== إضافة/حذف محلي + طابور ======== */
function addLocal(row){
  const rows=getRows(); rows.push(row); setRows(rows);
  const p=getPend(); p.push({op:'add',row}); setPend(p);
  render(); pushPending();
}
function deleteById(id){
  setRows(getRows().filter(x=>x.id!==id));
  const p=getPend(); p.push({op:'delete',id}); setPend(p);
  render(); pushPending();
}

/* ======== API ======== */
async function apiGet(){const r=await fetch(API_URL+'?action=get',{cache:'no-store'});return r.json();}
async function apiAdd(row){const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},keepalive:true,cache:'no-store',body:JSON.stringify({action:'add',...row})});return r.json();}
async function apiDelete(id){const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},keepalive:true,cache:'no-store',body:JSON.stringify({action:'delete',id})});return r.json();}

/* ======== مزامنة ======== */
async function pushPending(){
  const s=$('#state'); let p=getPend(); if(!p.length){s.textContent='تم التحديث من الشيت ✔';return}
  s.textContent='جارِ الرفع للشيت… ⏳';
  const remain=[];
  for(const job of p){
    try{
      if(job.op==='add') await apiAdd(calc(job.row));
      else if(job.op==='delete') await apiDelete(job.id);
    }catch(_){ remain.push(job); }
  }
  setPend(remain);
  s.textContent=remain.length?'فشل الرفع الآن، السجل محفوظ محليًا.':'تمت المزامنة ✔';
}
async function pullFromSheet(){
  $('#state').textContent='يجري السحب من الشيت…';
  try{
    const j=await apiGet();
    if(j?.ok){
      const pendAddIds=new Set(getPend().filter(x=>x.op==='add').map(x=>x.row.id));
      const rows=(j.data||[]).filter(r=>r&&r.id&&!pendAddIds.has(r.id));
      setRows(rows); render(); $('#state').textContent='تم التحديث من الشيت ✔';
    }else{$('#state').textContent='تعذّر التحديث الآن.'}
  }catch(_){$('#state').textContent='تعذّر التحديث الآن.'}
}

/* ======== أحداث واجهة ======== */
$('#inpDate').value=today();
$('#btnAdd').addEventListener('click',()=>{
  const row={
    id:uid(),
    date:$('#inpDate').value||today(),
    count:+$('#inpCount').value||0,
    price:+$('#inpPrice').value||0,
    harajPaid:$('#chkHarajPaid').checked,
    workerPaid:$('#chkWorkerPaid').checked
  };
  addLocal(row);
  $('#inpCount').value=''; $('#inpPrice').value='';
});
$('#body').addEventListener('click',e=>{
  const id=e.target?.dataset?.del; if(id) deleteById(id);
});
$('#btnPull').addEventListener('click',pullFromSheet);
$('#btnClear').addEventListener('click',()=>{ if(confirm('مسح التخزين المحلي فقط؟')){localStorage.removeItem(STORAGE_KEY);render();} });
$('#btnVersion').addEventListener('click',()=>{
  const kV='bk_version',kApi='bk_api';
  const keep=getRows(), pend=getPend();
  localStorage.clear(); setRows(keep); setPend(pend);
  localStorage.setItem(kV,APP_VERSION); localStorage.setItem(kApi,API_URL);
  render(); alert('تم تنظيف الكاش المحلي (تراجع النسخة).');
});

/* ======== تهيئة ======== */
(function init(){
  const kV='bk_version',kApi='bk_api';
  if(localStorage.getItem(kV)!==APP_VERSION || localStorage.getItem(kApi)!==API_URL){
    const keep=getRows(), pend=getPend();
    localStorage.clear(); setRows(keep); setPend(pend);
    localStorage.setItem(kV,APP_VERSION); localStorage.setItem(kApi,API_URL);
  }
})();
render();            // اعرض المحلي فورًا
pushPending();       // حاول رفع المعلّق
pullFromSheet();     // اسحب من الشيت ليصير نفس البيانات بكل الأجهزة
</script>
</body>
</html>
