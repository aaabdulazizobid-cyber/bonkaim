ج<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>برنامج بيع البونيكام (Sync مع Google Sheets)</title>

  <meta name="theme-color" content="#FFD700">
  <style>
    :root{
      --bg:#f8f9fb; --card:#fff; --ink:#111; --muted:#666;
      --green:#c6efce; --red:#ffc7ce; --yellow:#fff2cc; --blue:#ddebf7;
      --lightgreen:#e2efda; --orange:#fce4d6; --pink:#ead1dc; --steel:#d9e1f2; --net:#c6e0b4;
      --brand:#ffd700; --brand-ink:#111;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic","Helvetica Neue",Arial,sans-serif;line-height:1.5}
    header{background:var(--brand);color:var(--brand-ink);border-bottom:1px solid #e0c200;padding:12px;text-align:center;font-weight:800}
    .wrap{max-width:1200px;margin:auto;padding:14px}
    .card{background:var(--card);border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:12px}
    .form{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px;align-items:end}
    label{font-size:13px;color:#555;display:block;margin-bottom:6px}
    input[type="date"],input[type="number"]{width:100%;padding:12px 10px;font-size:16px;border:1.5px solid #bbb;border-radius:10px;background:#fff}
    input[type="checkbox"]{width:22px;height:22px}
    button{padding:12px 14px;font-size:15px;border:1px solid #222;border-radius:10px;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    .hint{font-size:12px;color:#666;margin-top:6px}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#eee;border:1px solid #ddd}
    .ok{background:#e6ffe6;border-color:#b8f2b8}
    .bad{background:#ffecec;border-color:#ffc9c9}
    .table-wrap{margin-top:12px;background:var(--card);border:1px solid #000;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fafafa;z-index:1;border-bottom:2px solid #000;font-size:14px;padding:12px;text-align:center}
    tbody td{padding:10px 8px;border-bottom:1px solid #000;border-top:1px solid #000;border-right:1px solid #000}
    tbody tr:nth-child(even){background:#fcfcfc}
    tfoot td{padding:12px 8px;font-weight:bold;border-top:3px solid #000;background:#f0f0f0}
    .center{text-align:center}
    .num{font-variant-numeric:tabular-nums}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600}
    .paid{background:var(--green)} .unpaid{background:var(--red)}
    .cell-date{background:var(--yellow)} .cell-count{background:var(--blue)}
    .cell-price{background:var(--lightgreen)} .cell-total{background:var(--orange)}
    .cell-fee{background:var(--pink)} .cell-worker{background:var(--steel)}
    .cell-net{background:var(--net)}
    .del-btn{background:#fff;color:#b00020;border:1px solid #ffd6d6;border-radius:8px;padding:6px 10px;cursor:pointer}
    .row-actions{display:flex;gap:6px;justify-content:center}
    @media (max-width:900px){.form{grid-template-columns:1fr 1fr;gap:8px} thead th{font-size:13px} tbody td{font-size:14px}}
  </style>
</head>
<body>
  <header>برنامج بيع البونيكام — متزامن مع Google Sheets</header>

  <div class="wrap">

    <!-- الشريط -->
    <div class="bar">
      <span id="conn" class="pill">التحقق من الاتصال…</span>
      <button id="btnPull" class="secondary">تحديث من الشيت ⟳</button>
      <button id="btnClearLocal" class="secondary">مسح المحلي</button>
    </div>

    <!-- النموذج -->
    <div class="card">
      <form id="entryForm" class="form">
        <div>
          <label>التاريخ</label>
          <input type="date" id="date" required>
        </div>
        <div>
          <label>عدد الفلين</label>
          <input type="number" id="count" inputmode="numeric" min="0" step="1" placeholder="مثال: 100">
        </div>
        <div>
          <label>سعر الفلين (ريال)</label>
          <input type="number" id="price" inputmode="decimal" min="0" step="0.01" placeholder="مثال: 25">
        </div>
        <div class="center">
          <label for="harajPaid" style="margin-bottom:6px">دفع الحراج</label>
          <input type="checkbox" id="harajPaid">
        </div>
        <div class="center">
          <label for="workerPaid" style="margin-bottom:6px">دفع أجرة العامل</label>
          <input type="checkbox" id="workerPaid">
        </div>
        <div class="center">
          <button id="btnAdd" type="submit">+ إضافة</button>
        </div>
      </form>
      <div class="hint">الأجرة = <b>2 ريال</b> × عدد الفلين — الحراج = <b>1%</b> من الإجمالي — يحفظ تلقائيًا ويتزامن مع Google Sheets.</div>
    </div>

    <!-- الجدول -->
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>إجراءات</th>
            <th>رسوم حراج</th>
            <th class="cell-net">صافي الربح</th>
            <th class="cell-worker">أجرة العامل (2/فلين)</th>
            <th class="cell-fee">حراج 1%</th>
            <th class="cell-total">الإجمالي</th>
            <th class="cell-price">سعر الفلين</th>
            <th class="cell-count">عدد الفلين</th>
            <th class="cell-date">التاريخ</th>
            <th>حالة الأجرة</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td>الإجماليات</td>
            <td></td>
            <td id="tNet" class="num center">0.00</td>
            <td id="tWorker" class="num center">0.00</td>
            <td id="tFee" class="num center">0.00</td>
            <td id="tTotal" class="num center">0.00</td>
            <td id="tAvgPrice" class="num center">0.00 (متوسط)</td>
            <td id="tCount" class="num center">0</td>
            <td></td>
            <td class="center" style="font-size:12px">المصدر: Google Sheets</td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>

<script>
/* ======================= إعداد NoCodeAPI ======================= */
const API_BASE = 'https://v1.nocodeapi.com/bonkaim/google_sheets/MpBntOqzeXdxSGmZ';
const TAB      = 'الورقة1';
const keyLocal = 'bonikam_sync_cache_v1';

let rows = []; // الشكل: {row_id, id, date, count, price, total, fee, worker, net, harajPaid, workerPaid}

/* ======================= أدوات مساعدة ======================= */
function todayISO(){
  const d = new Date();
  const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return tz.toISOString().slice(0,10);
}
function compute(obj){
  const count  = Number(obj.count)||0;
  const price  = Number(obj.price)||0;
  const total  = +(count * price).toFixed(2);
  const fee    = +(total * 0.01).toFixed(2);
  const worker = +(count * 2).toFixed(2);
  const net    = +(total - fee - worker).toFixed(2);
  return {...obj,total,fee,worker,net};
}
function badge(ok){ return ok ? '<span class="badge paid">تم الدفع</span>' : '<span class="badge unpaid">لم يتم الدفع</span>'; }
function saveLocal(){ localStorage.setItem(keyLocal, JSON.stringify(rows)); }
function loadLocal(){ rows = JSON.parse(localStorage.getItem(keyLocal)||'[]'); }

/* ======================= اتصال NoCodeAPI ======================= */
async function testConnection(){
  const pill = document.getElementById('conn');
  try{
    const url = `${API_BASE}?tabId=${encodeURIComponent(TAB)}&perPage=1`;
    const r = await fetch(url);
    if(!r.ok) throw 0;
    pill.classList.remove('bad'); pill.classList.add('ok'); pill.textContent = 'متصل بـ Google Sheets ✓';
    return true;
  }catch(e){
    pill.classList.remove('ok'); pill.classList.add('bad'); pill.textContent = 'غير متصل بالشيت — حافظ محليًا';
    return false;
  }
}

/* ======================= عمليات API ======================= */
async function apiGetAll(){
  const url = `${API_BASE}?tabId=${encodeURIComponent(TAB)}&perPage=10000`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('فشل القراءة من الشيت');
  const js = await r.json();
  const list = (js.data||[]).map(x => ({
    row_id: x.row_id,
    id: x.id ?? '',
    date: x.date ?? '',
    count: Number(x.count ?? 0),
    price: Number(x.price ?? 0),
    total: Number(x.total ?? 0),
    fee: Number(x.fee ?? 0),
    worker: Number(x.worker ?? 0),
    net: Number(x.net ?? 0),
    harajPaid: String(x.harajPaid ?? '').toUpperCase()==='TRUE',
    workerPaid: String(x.workerPaid ?? '').toUpperCase()==='TRUE',
  }));
  rows = list;
  saveLocal();
  render();
}

async function apiAdd(obj){
  // يضيف ككائن JSON مباشرة
  const url = `${API_BASE}?tabId=${encodeURIComponent(TAB)}`;
  const body = { data: [compute(obj)] };
  const r = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error('فشل الإضافة للشيت');
  // رجّع آخر نسخة من الشيت لضمان row_id
  await apiGetAll();
}

async function apiDelete(row_id){
  const url = `${API_BASE}?tabId=${encodeURIComponent(TAB)}&row_id=${encodeURIComponent(row_id)}`;
  const r = await fetch(url, { method:'DELETE' });
  if(!r.ok) throw new Error('فشل الحذف من الشيت');
  rows = rows.filter(rw => rw.row_id !== row_id);
  saveLocal(); render();
}

async function apiUpdate(row_id, obj){
  const url = `${API_BASE}?tabId=${encodeURIComponent(TAB)}&row_id=${encodeURIComponent(row_id)}`;
  const r = await fetch(url, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ data: compute(obj) })
  });
  if(!r.ok) throw new Error('فشل التحديث');
  await apiGetAll();
}

/* ======================= الواجهة ======================= */
function render(){
  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  // ترتيب بالتاريخ ثم بالمعرّف
  rows.sort((a,b)=> (a.date||'').localeCompare(b.date||'') || String(a.id).localeCompare(String(b.id)));

  for(const e of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="row-actions">
        <button class="del-btn" data-row="${e.row_id||''}">حذف</button>
      </td>
      <td class="center">${badge(!!e.harajPaid)}</td>
      <td class="cell-net num center">${(e.net??0).toFixed(2)}</td>
      <td class="cell-worker num center">${(e.worker??0).toFixed(2)}</td>
      <td class="cell-fee num center">${(e.fee??0).toFixed(2)}</td>
      <td class="cell-total num center">${(e.total??0).toFixed(2)}</td>
      <td class="cell-price num center">${Number(e.price||0)}</td>
      <td class="cell-count num center">${Number(e.count||0)}</td>
      <td class="cell-date center">${e.date||''}</td>
      <td class="center">${badge(!!e.workerPaid)}</td>
    `;
    // حذف
    tr.querySelector('.del-btn').addEventListener('click', async ev=>{
      if(!e.row_id){ alert('هذه السطر غير متزامن بعد. حدّث من الشيت أولاً.'); return; }
      if(confirm('متأكد تبي تحذف السطر من الشيت؟')){
        try{ await apiDelete(e.row_id); }
        catch(err){ alert(err.message||'تعذر الحذف'); }
      }
    });

    tbody.appendChild(tr);
  }

  // الإحصائيات
  const sum = k => rows.reduce((a,c)=>a+Number(c[k]||0),0);
  const priceAvg = rows.filter(e=>Number(e.price)>0).length ?
                   (sum('price')/rows.filter(e=>Number(e.price)>0).length) : 0;
  document.getElementById('tCount').textContent   = sum('count').toFixed(0);
  document.getElementById('tTotal').textContent   = sum('total').toFixed(2);
  document.getElementById('tFee').textContent     = sum('fee').toFixed(2);
  document.getElementById('tWorker').textContent  = sum('worker').toFixed(2);
  document.getElementById('tNet').textContent     = sum('net').toFixed(2);
  document.getElementById('tAvgPrice').textContent = priceAvg.toFixed(2)+' (متوسط)';
}

document.getElementById('entryForm').addEventListener('submit', async ev=>{
  ev.preventDefault();
  const obj = {
    id: Date.now()+''+Math.random().toString(16).slice(2),
    date: document.getElementById('date').value || todayISO(),
    count: Number(document.getElementById('count').value)||0,
    price: Number(document.getElementById('price').value)||0,
    harajPaid: document.getElementById('harajPaid').checked,
    workerPaid: document.getElementById('workerPaid').checked,
  };
  try{
    await apiAdd(obj);
    document.getElementById('count').value='';
    document.getElementById('price').value='';
  }catch(err){
    alert('تعذر الإرسال للشيت الآن، السطر لن يُحفظ. \nالسبب: '+(err.message||'غير معروف'));
  }
});

document.getElementById('btnPull').addEventListener('click', async ()=>{
  try{ await apiGetAll(); }
  catch(err){ alert(err.message||'تعذر التحديث من الشيت'); }
});

document.getElementById('btnClearLocal').addEventListener('click', ()=>{
  if(confirm('مسح النسخة المحلية المعروضة؟ (لا يحذف من الشيت)')){
    rows = []; saveLocal(); render();
  }
});

/* ======================= تشغيل أولي ======================= */
document.getElementById('date').value = todayISO();
loadLocal(); render();
testConnection().then(ok=>{
  // سحب مباشر عند أول تحميل لعرض بيانات الشيت
  apiGetAll().catch(()=>{/* يبقى المحلي */});
});
</script>
</body>
</html>
