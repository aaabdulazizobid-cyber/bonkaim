<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bonkaim — برنامج بيع البونيكام</title>
<meta name="theme-color" content="#ffd000">

<!-- فافيكون (أيقونة التبويب) صفراء مكتوب Bonkaim -->
<link rel="icon" type="image/svg+xml"
href='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
  <rect width="512" height="512" fill="%23ffd000"/>
  <text x="50%" y="58%" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-weight="700"
        font-size="140" fill="%23000">bon</text>
</svg>'>

<style>
  /* ألوان محسّنة قريبة من نسختك القديمة */
  :root{
    --gold:#ffd000;      /* أصفر الشعار */
    --bg:#fffef6;        /* خلفية فاتحة دافئة */
    --ink:#111;
    --muted:#666;
    --ok:#2e7d32;
    --danger:#b00020;
    --line:#000;         /* حدود سوداء واضحة */
    --thead:#f9f2b7;     /* رأس الجدول على أصفر فاتح */
    --stripe:#fff9d9;    /* صفوف متناوبة */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic","Helvetica Neue",Arial,sans-serif}
  header{
    background:var(--gold); border-bottom:2px solid var(--line);
    padding:10px 14px; display:flex; align-items:center; gap:10px; justify-content:center;
  }
  .logo-badge{
    background:var(--gold); color:#000; font-weight:800; letter-spacing:.3px;
    padding:6px 12px; border:2px solid var(--line); border-radius:10px;
    box-shadow:0 2px 0 var(--line);
  }
  .title{font-weight:800}
  .wrap{max-width:1100px;margin:auto;padding:14px}
  .card{background:#fff;border:2px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
  .top-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  button{
    padding:12px 14px;font-size:15px;border:2px solid var(--line);
    border-radius:10px;background:#111;color:#fff;cursor:pointer
  }
  .secondary{background:#fff;color:#111}
  .green{background:var(--ok);border-color:var(--line)}
  .danger{background:#fff;color:var(--danger);border-color:#ffd6d6}
  .status{font-size:12px;color:#222}

  .form{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px;align-items:end}
  label{font-size:13px;color:#333;display:block;margin:4px 0 6px;font-weight:700}
  input[type="date"],input[type="number"]{
    width:100%;padding:12px 10px;font-size:16px;border:2px solid var(--line);border-radius:10px;background:#fff
  }
  input[type="checkbox"]{width:22px;height:22px;accent-color:var(--ok)}

  .table-wrap{margin-top:12px;background:#fff;border:2px solid var(--line);border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;z-index:1;background:var(--thead);
    border-bottom:3px solid var(--line);font-size:14px;padding:12px;text-align:center
  }
  tbody td{
    padding:10px 8px;border-bottom:1px solid var(--line);
    border-top:1px solid var(--line);border-right:1px solid var(--line);text-align:center
  }
  tbody tr:nth-child(even){background:var(--stripe)}
  tfoot td{padding:12px 8px;font-weight:bold;border-top:3px solid var(--line);background:#f3f1dc;text-align:center}
  .num{font-variant-numeric:tabular-nums}
  .hint{font-size:12px;color:#444;margin-top:6px}
  .row-actions button{padding:6px 10px;font-size:13px}

  @media (max-width:900px){.form{grid-template-columns:1fr 1fr;gap:8px}}
</style>
</head>
<body>
<header>
  <span class="logo-badge">Bonkaim</span>
  <span class="title">برنامج بيع البونيكام — متزامن مع Google Sheets</span>
</header>

<div class="wrap">

  <div class="card">
    <div class="top-actions">
      <button class="secondary" id="btnPull">تحديث من الشيت</button>
      <button class="secondary" id="btnClearLocal">مسح المحلي</button>
      <span id="syncStat" class="status">جاهز.</span>
    </div>

    <form id="entryForm" class="form">
      <div>
        <label>عدد الفلين</label>
        <input type="number" id="count" inputmode="numeric" min="0" step="1" placeholder="مثال: 100" required>
      </div>
      <div>
        <label>التاريخ</label>
        <input type="date" id="date" required>
      </div>
      <div>
        <label>سعر الفلين (ريال)</label>
        <input type="number" id="price" inputmode="decimal" min="0" step="0.01" placeholder="مثال: 25" required>
      </div>
      <div>
        <label style="margin-bottom:6px">دفع الحراج</label><br>
        <input type="checkbox" id="harajPaid">
      </div>
      <div>
        <label style="margin-bottom:6px">دفع أجرة العامل</label><br>
        <input type="checkbox" id="workerPaid">
      </div>
      <div>
        <button type="submit" class="green" style="width:100%">+ إضافة</button>
      </div>
    </form>
    <div class="hint">الأجرة = <b>2 ريال</b> × عدد الفلين — الحراج = <b>1%</b> من الإجمالي — الحفظ محلي + مزامنة مع Google Sheets.</div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>إجراء</th>
          <th>رسوم حراج</th>
          <th>صافي الربح</th>
          <th>أجرة العامل (2/فلين)</th>
          <th>حراج 1%</th>
          <th>الإجمالي</th>
          <th>سعر الفلين</th>
          <th>عدد الفلين</th>
          <th>التاريخ</th>
          <th>دفع الأجرة</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>الإجماليات</td>
          <td></td>
          <td id="tNet" class="num">0.00</td>
          <td id="tWorker" class="num">0.00</td>
          <td id="tFee" class="num">0.00</td>
          <td id="tTotal" class="num">0.00</td>
          <td id="tAvgPrice" class="num">0.00 (متوسط)</td>
          <td id="tCount" class="num">0</td>
          <td></td>
          <td style="font-size:12px">يحفظ تلقائيًا + مزامنة بالشيت</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ====== روابط NoCodeAPI (جاهزة حسب إعدادك الحالي) ====== */
/* GET: جلب البيانات من الشيت (أنت قلت تبويبك اسمه "الورقة1") */
const GET_URL = 'https://v1.nocodeapi.com/bonkaim/google_sheets/MpBntOqzeXdxSGmZ?tabId=الورقة1';
/* POST: إضافة صفوف كـ JSON objects */
const ADD_URL = 'https://v1.nocodeapi.com/bonkaim/google_sheets/MpBntOqzeXdxSGmZ/addRows?tabId=الورقة1';

const LS_KEY = 'bonikam_sync_v1';
let entries = [];

function todayISO(){
  const d = new Date();
  const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return tz.toISOString().slice(0,10);
}
function load(){ entries = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(entries)); }
function status(txt){ document.getElementById('syncStat').textContent = txt; }

function compute(e){
  const c = +e.count||0, p = +e.price||0;
  const total = c*p;
  const fee = +(total*0.01).toFixed(2);
  const worker = +(c*2).toFixed(2);
  const net = +(total - fee - worker).toFixed(2);
  e.total=+total.toFixed(2); e.fee=fee; e.worker=worker; e.net=net;
  return e;
}

function render(){
  const tb = document.getElementById('tbody'); tb.innerHTML='';
  entries.sort((a,b)=> a.date.localeCompare(b.date));
  for(const e of entries){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="row-actions"><button class="danger" onclick="delRow('${e.id}')">حذف</button></td>
      <td>${e.harajPaid?'تم':'لم'}</td>
      <td class="num">${(e.net??0).toFixed(2)}</td>
      <td class="num">${(e.worker??0).toFixed(2)}</td>
      <td class="num">${(e.fee??0).toFixed(2)}</td>
      <td class="num">${(e.total??0).toFixed(2)}</td>
      <td class="num">${e.price}</td>
      <td class="num">${e.count}</td>
      <td>${e.date}</td>
      <td>${e.workerPaid?'تم':'لم'}</td>
    `;
    tb.appendChild(tr);
  }
  const sum = k=>entries.reduce((a,c)=>a+Number(c[k]||0),0);
  const priceAvg = entries.length? (entries.reduce((a,c)=>a+Number(c.price||0),0)/entries.length):0;
  document.getElementById('tCount').textContent = sum('count').toFixed(0);
  document.getElementById('tTotal').textContent = sum('total').toFixed(2);
  document.getElementById('tFee').textContent   = sum('fee').toFixed(2);
  document.getElementById('tWorker').textContent= sum('worker').toFixed(2);
  document.getElementById('tNet').textContent   = sum('net').toFixed(2);
  document.getElementById('tAvgPrice').textContent = priceAvg.toFixed(2)+' (متوسط)';
}

function delRow(id){
  entries = entries.filter(x=>x.id!==id);
  save(); render(); status('حُذف محليًا (لن يُحذف من الشيت).');
}

async function addEntry(ev){
  ev.preventDefault();
  const date = document.getElementById('date').value || todayISO();
  const count = +document.getElementById('count').value || 0;
  const price = +document.getElementById('price').value || 0;
  const harajPaid = document.getElementById('harajPaid').checked;
  const workerPaid = document.getElementById('workerPaid').checked;

  const row = compute({
    id: Date.now()+''+Math.random().toString(16).slice(2),
    date, count, price, harajPaid, workerPaid
  });

  entries.push(row); save(); render();

  try{
    status('جارِ الرفع للشيت...');
    const res = await fetch(ADD_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        data: [{
          id: row.id,
          date: row.date,
          count: row.count,
          price: row.price,
          total: row.total,
          fee: row.fee,
          worker: row.worker,
          net: row.net,
          harajPaid: row.harajPaid ? 'TRUE' : 'FALSE',
          workerPaid: row.workerPaid ? 'TRUE' : 'FALSE'
        }]
      })
    });
    if(!res.ok){
      const t = await res.text();
      status('تعذّر الإرسال للشيت. يبقى محفوظ محليًا.');
      alert('تعذّر الإرسال للشيت الآن، السطر محفوظ محليًا.\n\nنص الاستجابة:\n'+t);
    }else{
      status('تمت الإضافة للشيت ✔️');
    }
  }catch(err){
    status('الشيت غير متاح الآن.');
    alert('تعذّر الإرسال للشيت الآن، السطر محفوظ محليًا.\nجرّب لاحقًا زر (تحديث من الشيت).');
  }

  document.getElementById('count').value='';
  document.getElementById('price').value='';
}

async function pullFromSheet(){
  try{
    status('جارِ التحديث من الشيت...');
    const res = await fetch(GET_URL);
    if(!res.ok){ throw new Error('GET failed'); }
    const data = await res.json();
    const rows = Array.isArray(data.data)? data.data : [];
    entries = rows.map(r => compute({
      id: r.id ?? r.ID ?? '',
      date: r.date ?? '',
      count: +r.count || 0,
      price: +r.price || 0,
      total: +r.total || 0,
      fee: +r.fee || 0,
      worker: +r.worker || 0,
      net: +r.net || 0,
      harajPaid: (r.harajPaid===true || r.harajPaid==='TRUE'),
      workerPaid:(r.workerPaid===true || r.workerPaid==='TRUE')
    }));
    save(); render(); status('تم التحديث من الشيت ✔️');
  }catch(e){
    status('تعذّر التحديث من الشيت.');
    alert('ما قدرنا نسحب من الشيت. تأكد من رابط GET ومن حد الاستخدام في NoCodeAPI.');
  }
}

document.getElementById('date').value = todayISO();
document.getElementById('entryForm').addEventListener('submit', addEntry);
document.getElementById('btnPull').addEventListener('click', pullFromSheet);
document.getElementById('btnClearLocal').addEventListener('click', ()=>{
  if(confirm('متأكد تبي تمسح النسخة المحلية فقط؟')){
    entries=[]; save(); render(); status('تم مسح المحلي. (الشيت ما تغيّر)');
  }
});

load(); render();
</script>
</body>
</html>
