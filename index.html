<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>برنامج بيع البونيكام — نسخة سريعة</title>
<meta name="theme-color" content="#FFD700"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --ink:#0f0f0f; --muted:#666; --bg:#f7f7f8; --card:#fff;
    --gold:#ffd400; --border:#000;
    --c1:#f7f0e2; --c2:#e8f3e2; --c3:#e7f0fb; --c4:#ffe9b6;
    --c5:#f3e0e7; --c6:#e6ecfa; --c7:#e7f4e1;
    --ok:#2e7d32; --bad:#b00020; --ok-bg:#dbf2df; --bad-bg:#f8d7da;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic","Helvetica Neue",Arial,sans-serif}
  header{background:var(--gold); border-bottom:2px solid var(--border); padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .logo{display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px}
  .logo-badge{width:34px;height:34px;border-radius:8px;background:#111;color:#ffd400;display:grid;place-items:center;font-weight:800}
  .wrap{max-width:1100px;margin:auto;padding:14px}
  .toolrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  button{padding:10px 14px;border:1.8px solid var(--border);border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .ghost{background:#fff;color:#111}
  .danger{background:#fff;color:#b00020;border-color:#b00020}
  label{font-size:12px;color:var(--muted);margin:0 0 5px;display:block}
  .inputs{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:8px}
  input[type="number"],input[type="date"]{width:100%;padding:10px;border:1.8px solid #bbb;border-radius:10px;background:#fff;font-size:16px}
  .table-wrap{background:#fff;border:2px solid var(--border);border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#fafafa;border-bottom:2px solid var(--border);padding:10px;text-align:center}
  tbody td,tfoot td{padding:10px;border-top:1.5px solid var(--border);border-right:1.5px solid var(--border);text-align:center}
  tbody tr:nth-child(even){background:#fcfcfc}
  .num{font-variant-numeric:tabular-nums}
  .c-total{background:var(--c1)} .c-price{background:var(--c2)} .c-count{background:var(--c3)}
  .c-date{background:var(--c4)} .c-fee{background:var(--c5)} .c-worker{background:var(--c6)} .c-net{background:var(--c7)}
  .rowbtn{background:#111;color:#fff;border:1.8px solid var(--border);padding:6px 10px;border-radius:10px}
  tfoot td{background:#f1f1f1;font-weight:700}
  .flagbox{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border:2px solid var(--border);border-radius:6px;font-weight:800;font-size:18px}
  .flag-ok{background:var(--ok-bg);color:var(--ok)} .flag-no{background:var(--bad-bg);color:var(--bad)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  input[type="file"]{display:none}
  @media (max-width:900px){.inputs{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header>
  <div class="logo">
    <span class="logo-badge">B</span><span>bonkaim</span>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="ghost" id="btnPull">تحديث من الشيت</button>
    <button class="ghost" id="btnClearLocal">مسح المحلي</button>
    <button class="ghost" id="btnBackup">تراجع/نسخة</button>
    <button class="ghost" id="btnCsv">تصدير CSV</button>
    <label class="ghost" for="fileRestore" style="display:inline-block;cursor:pointer;padding:10px 14px;border-radius:10px;border:1.8px solid var(--border)">استرجاع</label>
    <input id="fileRestore" type="file" accept="application/json">
  </div>
</header>

<div class="wrap">
  <div class="toolrow"><span id="syncStat" class="hint">جاهز. يحفظ محليًا + يزامن عند الاتصال.</span></div>

  <div class="card">
    <div class="inputs">
      <div><label>عدد الفلين</label><input id="count" type="number" inputmode="numeric" min="0" step="1" placeholder="مثال: 100"></div>
      <div><label>التاريخ</label><input id="date" type="date"></div>
      <div><label>سعر الفلين (ريال)</label><input id="price" type="number" inputmode="decimal" min="0" step="0.01" placeholder="مثال: 25"></div>
      <div><label>حراج (مدفوع؟)</label><input id="harajPaid" type="checkbox"></div>
      <div><label>أجرة عامل (مدفوعة؟)</label><input id="workerPaid" type="checkbox"></div>
      <div style="display:flex;align-items:end"><button id="btnAdd">+ إضافة</button></div>
    </div>
    <div class="hint">الأجرة = <b>2 ريال</b> × عدد الفلين — الحراج = <b>1%</b> — يحفظ محليًا + يرفع للشيت عند الشبكة.</div>
  </div>

  <div class="table-wrap" style="margin-top:12px">
    <table id="tbl">
      <thead>
        <tr>
          <th>إجراءات</th><th>حراج</th><th>أجرة عامل</th>
          <th class="c-net">صافي الربح</th><th class="c-worker">أجر العامل (2/فلين)</th>
          <th class="c-fee">حراج %1</th><th class="c-total">الإجمالي</th>
          <th class="c-price">سعر الفلين</th><th class="c-count">عدد الفلين</th><th class="c-date">التاريخ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>الإجماليات</td><td></td><td></td>
          <td class="num" id="tNet">0.00</td><td class="num" id="tWorker">0.00</td>
          <td class="num" id="tFee">0.00</td><td class="num" id="tTotal">0.00</td>
          <td class="num" id="tAvgPrice">0.00 (متوسط)</td><td class="num" id="tCount">0</td>
          <td style="font-size:12px">يحفظ تلقائيًا + مزامنة بالشيت</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ===== إعدادات ===== */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyx9A-ujkCNCT_KWOMxZkGNFIGdpUlx5-n6-U6_URaSdlWYiA70WI4-SUMgjRez8dnQ/exec';

/* مفاتيح تخزين جديدة v3 */
const LS_ROWS   = 'bonikam_rows_v3';
const LS_QUEUE  = 'bonikam_queue_v3';
const $ = id => document.getElementById(id);

function todayISO(){ const d=new Date(); const t=new Date(d.getTime()-d.getTimezoneOffset()*60000); return t.toISOString().slice(0,10);}
$('date').value = todayISO();

function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function status(s){ $('syncStat').textContent=s; }

function compute(r){
  const c=+r.count||0, p=+r.price||0;
  const total=c*p;
  const fee=+(total*0.01).toFixed(2);
  const worker=+(c*2).toFixed(2);
  const net=+(total-fee-worker).toFixed(2);
  r.total=+total.toFixed(2); r.fee=fee; r.worker=worker; r.net=net; 
  return r;
}
function flagBox(tf){ return `<span class="flagbox ${tf?'flag-ok':'flag-no'}">${tf?'✓':'✗'}</span>`; }

let rows  = load(LS_ROWS, []);
let queue = load(LS_QUEUE, []);

function render(){
  const tb=$('tbody'); tb.innerHTML='';
  rows.sort((a,b)=> a.date.localeCompare(b.date) || (a.id||'').localeCompare(b.id||''));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <button class="rowbtn" onclick="delRow('${r.id}')">حذف</button>
      </td>
      <td>${flagBox(!!r.harajPaid)}</td>
      <td>${flagBox(!!r.workerPaid)}</td>
      <td class="num c-net">${(r.net??0).toFixed(2)}</td>
      <td class="num c-worker">${(r.worker??0).toFixed(2)}</td>
      <td class="num c-fee">${(r.fee??0).toFixed(2)}</td>
      <td class="num c-total">${(r.total??0).toFixed(2)}</td>
      <td class="num c-price">${r.price}</td>
      <td class="num c-count">${r.count}</td>
      <td class="c-date">${r.date}</td>`;
    tb.appendChild(tr);
  }
  const sum=k=>rows.reduce((a,c)=>a+Number(c[k]||0),0);
  const avg=rows.length? rows.reduce((a,c)=>a+Number(c.price||0),0)/rows.length : 0;
  $('tCount').textContent = sum('count').toFixed(0);
  $('tTotal').textContent = sum('total').toFixed(2);
  $('tFee').textContent   = sum('fee').toFixed(2);
  $('tWorker').textContent= sum('worker').toFixed(2);
  $('tNet').textContent   = sum('net').toFixed(2);
  $('tAvgPrice').textContent = avg.toFixed(2)+' (متوسط)';
}

function delRow(id){
  rows = rows.filter(x=>x.id!==id);
  save(LS_ROWS, rows); render(); status('حُذف محليًا.');
}

/* إرسال */
async function sendAdd(row){
  const res = await fetch(SCRIPT_URL+'?action=add',{
    method:'POST',
    headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
    body: JSON.stringify({
      id: row.id, date: row.date, count: row.count, price: row.price,
      total: row.total, fee: row.fee, worker: row.worker, net: row.net,
      harajPaid: row.harajPaid ? 'TRUE' : 'FALSE',
      workerPaid: row.workerPaid ? 'TRUE' : 'FALSE'
    })
  });
  if(!res.ok) throw new Error(await res.text());
}

async function flushQueue(){
  if(!queue.length) return;
  status('جارِ معالجة السجلات المعلّقة...');
  const remain=[];
  for(const it of queue){
    try{ await sendAdd(it.row || it); }catch(e){ remain.push(it); }
  }
  queue = remain; save(LS_QUEUE, queue);
  status(remain.length? 'لا يزال هناك سجلات معلّقة.' : 'تمت مزامنة السجلات المعلّقة ✔️');
}

/* سحب من الشيت + دمج */
function mergeById(localArr, sheetArr){
  const map = new Map();
  sheetArr.forEach(o=> map.set(o.id || (o.date+'-'+o.count+'-'+o.price), o));
  localArr.forEach(o=> map.set(o.id || (o.date+'-'+o.count+'-'+o.price), o)); // المحلي يغلب
  return Array.from(map.values());
}

async function pull(){
  try{
    status('جارِ التحديث من الشيت...');
    await flushQueue();
    const r = await fetch(SCRIPT_URL+'?action=get&perPage=1000',{cache:'no-store'});
    if(!r.ok) throw new Error('GET failed');
    const j = await r.json();
    const sheet = (Array.isArray(j.data)? j.data : []).map(o=>compute({
      id: o.id ?? '',
      date: o.date ?? '',
      count:+o.count||0, price:+o.price||0,
      total:+o.total||0, fee:+o.fee||0, worker:+o.worker||0, net:+o.net||0,
      harajPaid: (o.harajPaid===true || o.harajPaid==='TRUE' || o.harajPaid==='تم'),
      workerPaid:(o.workerPaid===true || o.workerPaid==='TRUE' || o.workerPaid==='تم')
    }));
    rows = mergeById(rows, sheet);
    save(LS_ROWS, rows); render();
    status('تم الدمج والتحديث من الشيت ✔️');
  }catch(e){
    status('تعذّر الجلب من الشيت.'); 
  }
}

/* بناء صف + إضافة */
function buildRow(){
  return compute({
    id: Date.now()+''+Math.random().toString(16).slice(2),
    date: $('date').value || todayISO(),
    count:+$('count').value||0,
    price:+$('price').value||0,
    harajPaid: $('harajPaid').checked,
    workerPaid: $('workerPaid').checked
  });
}
async function addRow(){
  const row=buildRow();
  rows.push(row); save(LS_ROWS, rows); render();
  try{ status('جارِ الإرسال للشيت...'); await sendAdd(row); status('تم الرفع للشيت ✔️'); await pull(); }
  catch(err){ queue.push({op:'add', row}); save(LS_QUEUE, queue); status('تعذّر الإرسال الآن—محفوظ محليًا.'); }
  $('count').value=''; $('price').value='';
}

/* نسخ احتياطي / استرجاع / CSV */
function download(name, text, type){
  const a=document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type}));
  a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
}
function backupNow(){
  const payload = { version:'v3', exportedAt:new Date().toISOString(), rows, queue };
  download('bonkaim-backup.json', JSON.stringify(payload, null, 2), 'application/json');
  status('تم تنزيل النسخة ✔️');
}
function restoreFromFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const j = JSON.parse(e.target.result);
      if(!j || !Array.isArray(j.rows)) throw new Error('ملف غير صالح');
      rows = (j.rows||[]).map(compute);
      queue = Array.isArray(j.queue)? j.queue : [];
      save(LS_ROWS, rows); save(LS_QUEUE, queue); render();
      status('تم الاسترجاع ✔️'); 
    }catch(err){ alert('تعذّر الاسترجاع: ملف غير صالح.'); }
  };
  reader.readAsText(file);
}
function toCSV(arr){
  const hdr = ['id','date','count','price','total','fee','worker','net','harajPaid','workerPaid'];
  const lines = [hdr.join(',')];
  for(const r of arr){
    const row = [
      r.id, r.date, r.count, r.price, r.total, r.fee, r.worker, r.net,
      r.harajPaid ? 'TRUE' : 'FALSE',
      r.workerPaid ? 'TRUE' : 'FALSE'
    ].map(x=> String(x??'').replace(/"/g,'""'));
    lines.push(row.map(v=> /[",\n]/.test(v) ? `"${v}"` : v).join(','));
  }
  return lines.join('\n');
}
function exportCSV(){ download('bonkaim-data.csv', toCSV(rows), 'text/csv'); status('تم تنزيل CSV ✔️'); }

/* أزرار */
$('btnAdd').addEventListener('click', addRow);
$('btnPull').addEventListener('click', pull);
$('btnClearLocal').addEventListener('click', ()=>{
  if(confirm('تمسح النسخة المحلية فقط؟')){ rows=[]; queue=[]; save(LS_ROWS, rows); save(LS_QUEUE, queue); render(); status('تم مسح المحلي.');}
});
$('btnBackup').addEventListener('click', backupNow);
$('btnCsv').addEventListener('click', exportCSV);
$('fileRestore').addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) restoreFromFile(e.target.files[0]); e.target.value=''; });

/* مزامنة تلقائية بين الأجهزة */
render();
/* عند التحميل: صفّ الطابور ثم اسحب من الشيت */
(async ()=>{ try{ await flushQueue(); await pull(); }catch{} })();
/* رجع النت */
window.addEventListener('online', ()=> { flushQueue().then(pull).catch(()=>{}); });
/* الصفحة صارت بالمقدمة */
document.addEventListener('visibilitychange', ()=> { if(document.visibilityState==='visible'){ flushQueue().then(pull).catch(()=>{}); }});
/* تحديث دوري خفيف كل 30 ثانية */
setInterval(()=>{ flushQueue().then(pull).catch(()=>{}); }, 30000);
</script>
</body>
</html>
