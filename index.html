<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>bonkaim</title>
<style>
  :root { --yellow:#ffd633; --ink:#111; --muted:#666; --ok:#43a047; --bad:#e53935; --bd:#e5e5e5; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background:#fff7cc; }
  header { position:sticky; top:0; z-index:3; background:var(--yellow); padding:10px 12px; display:flex; align-items:center; gap:10px; border-bottom:1px solid #00000022;}
  header h1 { margin:0; font-size:18px; font-weight:700; letter-spacing:.3px; }
  header .badge { margin-right:auto; background:#000; color:#ffd633; border-radius:8px; padding:2px 8px; font-weight:700; }
  .toolbar { display:flex; gap:8px; padding:8px 10px; flex-wrap:wrap; }
  .toolbar button { border:0; background:#000; color:#fff; padding:10px 12px; border-radius:10px; font-weight:700; box-shadow:0 2px 0 #00000033; }
  .toolbar button.alt { background:#fff; color:#111; border:1px solid #00000030; }
  .wrap { padding:10px; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .field { display:flex; flex-direction:column; gap:6px; }
  .field input[type="number"], .field input[type="date"], .field input[type="text"] {
    width:100%; padding:12px; border-radius:12px; border:2px solid #00000020; background:#fff; font-size:16px;
  }
  .chk { display:flex; align-items:center; gap:8px; }
  .addRow { margin-top:8px; }
  table { width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; background:#fff; }
  th,td { border:1px solid var(--bd); padding:10px 8px; text-align:center; font-size:14px; }
  thead th { position:sticky; top:58px; z-index:2; background:#fffef5; }
  tfoot td { font-weight:800; background:#fffef0; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; font-weight:700; }
  .ok { background:#e7f6ec; color:#1b5e20; }
  .bad { background:#fdeaea; color:#b71c1c; }
  .ghost { opacity:.6; }
  .btn-mini { border:0; padding:6px 10px; border-radius:10px; font-weight:700; background:#000; color:#fff; }
  .btn-del { background:#111; }
  .note { color:var(--muted); font-size:12px; padding:4px 2px; }
  .toast { position:fixed; inset:auto 12px 14px 12px; background:#111; color:#fff; padding:10px 12px; border-radius:10px; font-weight:600; display:none; z-index:10; }
</style>
</head>
<body>

<header>
  <h1>bonkaim</h1>
  <span class="badge">B</span>
</header>

<div class="toolbar">
  <button id="btnRefresh" class="alt">تحديث من الشيت</button>
  <button id="btnClear" class="alt">مسح المحلي</button>
  <button id="btnExport" class="alt">تصدير JSON</button>
</div>

<div class="wrap">
  <div class="grid">
    <div class="field">
      <label>التاريخ</label>
      <input id="fDate" type="date" />
    </div>
    <div class="field">
      <label>عدد الثلين</label>
      <input id="fCount" type="number" inputmode="numeric" placeholder="مثال: 100" />
    </div>
    <div class="field">
      <label>سعر الثلين (ريال)</label>
      <input id="fPrice" type="number" inputmode="numeric" placeholder="مثال: 25" />
    </div>
    <div class="field">
      <label class="chk"><input id="fHarajPaid" type="checkbox" checked /> حراج (مدفوع؟)</label>
    </div>
  </div>
  <button id="btnAdd" class="addRow">إضافة +</button>

  <p class="note">يحفظ محليًا ويُرفع تلقائيًا عند توفر الشبكة. “تحديث من الشيت” لا يمسح المحلي.</p>

  <div style="overflow:auto; margin-top:8px;">
    <table id="tbl">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>عدد</th>
          <th>سعر</th>
          <th>الإجمالي</th>
          <th>حراج 1%</th>
          <th>أجر العامل (2/قين)</th>
          <th>صافي الربح</th>
          <th>مرفوع</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>الإجماليات</td>
          <td id="tCount">0</td>
          <td id="tAvg">0.00 (متوسط)</td>
          <td id="tTotal">0.00</td>
          <td id="tFee">0.00</td>
          <td id="tWorker">0.00</td>
          <td id="tNet">0.00</td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== رابط سكربت Google Apps Script (لا تغيّره) ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyBlKn5FVFJm0FMp98ntQ8E3y9Ae_AlRzchLlXUEFcAcD32xW4nSFjRTgf9K5-PeynyoQ/exec';

/* ===== تخزين محلي ===== */
const LS_KEY = 'bonkaim.rows.v3';     // السجلات
const LS_QUEUE = 'bonkaim.queue.v3';  // طابور لم تُرفع بعد

const $ = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>[...root.querySelectorAll(s)];
const toast = (msg,ms=2000)=>{ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); };

function loadLS(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key) || '') ?? fallback; } catch { return fallback; }
}
function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ===== بيانات وعمليات ===== */
let localRows = loadLS(LS_KEY, []);     // [{id,date,count,price,total,fee,worker,net, harajPaid, workerPaid, _posted}]
let queue = loadLS(LS_QUEUE, []);       // [{...row}]

const fmt = n => (Number(n)||0).toFixed(2);

function recalcRow(r){
  const count = Number(r.count)||0;
  const price = Number(r.price)||0;
  const total = count * price;
  const fee = +(total * 0.01).toFixed(2);
  const worker = +(count * 2).toFixed(2);   // أجر العامل (افتراضي = 2 ريال لكل ثل)
  const net = +(total - fee - worker).toFixed(2);
  return { ...r, total, fee, worker, net };
}

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function render(){
  const tbody = $("#tbody");
  tbody.innerHTML = '';
  let sumCount=0, sumPrice=0, sumTotal=0, sumFee=0, sumWorker=0, sumNet=0;

  localRows.forEach(r=>{
    const tr = document.createElement('tr');
    if (!r._posted) tr.classList.add('ghost');

    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.count||0}</td>
      <td>${fmt(r.price)}</td>
      <td>${fmt(r.total)}</td>
      <td>${fmt(r.fee)}</td>
      <td>${fmt(r.worker)}</td>
      <td>${fmt(r.net)}</td>
      <td>${r._posted ? '<span class="pill ok">✓</span>' : '<span class="pill bad">بانتظار الرفع ⏳</span>'}</td>
      <td>
        <button class="btn-mini btn-del" data-id="${r.id}">حذف</button>
      </td>
    `;
    tbody.appendChild(tr);

    sumCount += Number(r.count)||0;
    sumPrice += Number(r.price)||0;
    sumTotal += Number(r.total)||0;
    sumFee += Number(r.fee)||0;
    sumWorker += Number(r.worker)||0;
    sumNet += Number(r.net)||0;
  });

  $("#tCount").textContent = sumCount;
  const avg = localRows.length ? (sumPrice/localRows.length) : 0;
  $("#tAvg").textContent = `${fmt(avg)} (متوسط)`;
  $("#tTotal").textContent = fmt(sumTotal);
  $("#tFee").textContent = fmt(sumFee);
  $("#tWorker").textContent = fmt(sumWorker);
  $("#tNet").textContent = fmt(sumNet);
}

function addLocalRow(row){
  localRows.unshift(row);
  saveLS(LS_KEY, localRows);
  render();
}

function delLocal(id){
  localRows = localRows.filter(r=>r.id!==id);
  saveLS(LS_KEY, localRows);
  render();
}

/* ===== تواصل مع الشيت ===== */
async function apiGet(){
  const url = API_URL + '?action=get';
  const res = await fetch(url, { method:'GET', cache:'no-store' });
  if(!res.ok) throw new Error('GET failed');
  const j = await res.json().catch(()=>({ok:false,data:[]}));
  if(!j.ok) throw new Error('GET bad response');
  return j.data||[];
}

async function apiPostRow(r){
  // نرسل application/x-www-form-urlencoded (يتوافق مع السكربت)
  const form = new URLSearchParams();
  Object.entries({
    id:r.id, date:r.date, count:r.count, price:r.price, total:r.total,
    fee:r.fee, worker:r.worker, net:r.net,
    harajPaid: r.harajPaid ? 'TRUE' : 'FALSE',
    workerPaid: r.workerPaid ? 'TRUE' : 'FALSE'
  }).forEach(([k,v])=>form.append(k, String(v ?? '')));

  const res = await fetch(API_URL, {
    method:'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: form
  });
  if(!res.ok) throw new Error('POST failed');
  const j = await res.json().catch(()=>({ok:false}));
  if(!j.ok) throw new Error('POST bad response');
  return j;
}

/* مزامنة الطابور */
async function syncQueue(){
  if(!navigator.onLine) return;
  if(queue.length===0) return;

  const pending = [...queue];
  for(const r of pending){
    try{
      await apiPostRow(r);
      // علّم المحلي بأنه مرفوع
      const i = localRows.findIndex(x=>x.id===r.id);
      if(i>-1){ localRows[i]._posted = true; saveLS(LS_KEY, localRows); }
      queue = queue.filter(x=>x.id!==r.id);
      saveLS(LS_QUEUE, queue);
    }catch(e){
      // إذا فشل، نتركه في الطابور
    }
  }
  render();
}

/* تحديث من الشيت (بدون حذف المحلي) */
async function refreshFromSheet(){
  try{
    const sheetRows = await apiGet(); // مصفوفة كائنات من السكربت
    // دمج: نحافظ على المحلي، ونضيف أي صف غير موجود من الشيت (حسب id)
    const known = new Set(localRows.map(r=>String(r.id)));
    const merged = [...localRows];

    sheetRows.forEach(sr=>{
      const id = String(sr.id||'');
      if(!id) return;
      if(!known.has(id)){
        const r = recalcRow({
          id,
          date: sr.date||'',
          count: Number(sr.count)||0,
          price: Number(sr.price)||0,
          harajPaid: String(sr.harajPaid||'').toUpperCase()==='TRUE',
          workerPaid: String(sr.workerPaid||'').toUpperCase()==='TRUE',
          _posted: true
        });
        merged.push({ ...r, _posted:true });
      }else{
        // لو موجود محليًا وكان غير مرفوع، لا نلمسه
        const idx = merged.findIndex(x=>String(x.id)===id);
        if(idx>-1 && merged[idx]._posted===true){
          // تحديث قيم محفوظة من الشيت (اختياري)
          merged[idx] = { ...merged[idx], ...recalcRow(sr), _posted:true };
        }
      }
    });

    // نحافظ على ترتيب الأحدث أولًا حسب التاريخ/الإنشاء
    merged.sort((a,b)=>String(b.id).localeCompare(String(a.id)));

    localRows = merged;
    saveLS(LS_KEY, localRows);
    render();
    toast('تم التحديث من الشيت بنجاح');
  }catch(e){
    toast('تعذر التحديث من الشيت الآن');
  }
}

/* ===== أحداث الواجهة ===== */
$("#btnAdd").addEventListener('click', async ()=>{
  const date = $("#fDate").value || new Date().toISOString().slice(0,10);
  const count = Number($("#fCount").value||0);
  const price = Number($("#fPrice").value||0);
  const harajPaid = $("#fHarajPaid").checked;

  if(!count || !price){ toast('أدخل العدد والسعر'); return; }

  const base = { id: uid(), date, count, price, harajPaid, workerPaid:false, _posted:false };
  const row = recalcRow(base);

  addLocalRow(row);
  queue.push({...row}); saveLS(LS_QUEUE, queue);
  toast('انحفظ محليًا • سيتم الرفع تلقائيًا');
  syncQueue();
});

$("#tbody").addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('.btn-del');
  if(!btn) return;
  const id = btn.dataset.id;
  // حذف محلي فقط (لا نحذف من الشيت لتجنّب أخطاء)
  delLocal(id);
  // وكذلك لو كان في الطابور احذفه
  queue = queue.filter(r=>r.id!==id); saveLS(LS_QUEUE, queue);
  toast('تم حذف السجل محليًا');
});

$("#btnClear").addEventListener('click', ()=>{
  if(!confirm('سيتم مسح النسخ المحلية فقط. متابعة؟')) return;
  localRows = []; saveLS(LS_KEY, localRows);
  queue = []; saveLS(LS_QUEUE, queue);
  render();
  toast('تم مسح المحلي');
});

$("#btnRefresh").addEventListener('click', refreshFromSheet);

$("#btnExport").addEventListener('click', ()=>{
  const data = JSON.stringify(localRows, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `bonkaim-backup-${Date.now()}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* مزامنة عند الاتصال */
window.addEventListener('online', syncQueue);

/* تشغيل أولي */
(function init(){
  // تاريخ اليوم افتراضي
  $("#fDate").value = new Date().toISOString().slice(0,10);
  render();
  // محاولة رفع أي شيء متبقي
  syncQueue();
})();
</script>
</body>
</html>
