<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>bonkaim</title>
<style>
  :root{
    --yellow:#f7c900;
    --ink:#111;
    --muted:#666;
    --ok:#1aa36f;
    --bad:#e05252;
    --pill:#111;
    --bg:#f7f7f7;
    --br:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Tahoma,Arial,sans-serif}
  .topbar{
    position:sticky;top:0;z-index:10;background:var(--yellow);border-bottom:1px solid rgba(0,0,0,.05)
  }
  .topbar .wrap{max-width:980px;margin:auto;display:flex;align-items:center;gap:12px;padding:10px 12px}
  .brand{margin-inline-start:auto;display:flex;align-items:center;gap:10px;font-weight:800}
  .badge{background:var(--pill);color:#fff;border-radius:8px;padding:4px 8px}
  .btn{appearance:none;border:0;background:#000;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.alt{background:#fff;color:#000;border:1px solid #ddd}
  .btn.ghost{background:#000;color:#fff}
  .btn.small{padding:8px 10px;border-radius:9px;font-weight:700}
  .btn.danger{background:#111}
  .container{max-width:980px;margin:18px auto;padding:0 12px}
  .hint{color:var(--muted);font-size:.88rem;margin-top:10px}
  .card{border:1px solid #e7e7e7;border-radius:16px;overflow:hidden;background:#fff}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input[type="text"], .field input[type="number"], .field input[type="date"]{
    width:100%;padding:12px 10px;border-radius:12px;border:1px solid #e1e1e1;background:#fff;font-size:16px
  }
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
  .table-wrap{margin-top:14px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:64px;background:#fff;border-bottom:1px solid #eee;z-index:5}
  th,td{padding:12px 10px;border-inline-end:1px solid #eee;border-bottom:1px solid #eee;text-align:center;white-space:nowrap}
  th:last-child, td:last-child{border-inline-end:0}
  tr:first-child th:first-child{border-top-right-radius:12px}
  tr:first-child th:last-child{border-top-left-radius:12px}
  .col-date{background:#ffe18a}
  .col-count{background:#eaf6ff}
  .col-price{background:#ecffe8}
  .col-total{background:#fff6e7}
  .col-fee{background:#ffe8ef}
  .col-worker{background:#e8f0ff}
  .col-net{background:#e9f9ef}
  .actions{background:#fff}
  .pill-ok,.pill-no{
    display:inline-flex;align-items:center;justify-content:center;
    width:36px;height:36px;border-radius:10px;border:1px solid #ddd;background:#fff
  }
  .pill-ok:after{content:"✓";color:var(--ok);font-weight:900}
  .pill-no:after{content:"✕";color:var(--bad);font-weight:900}
  .trash{background:#000;color:#fff;border-radius:10px;border:0;padding:8px 14px;cursor:pointer}
  tfoot td{font-weight:800;background:#fafafa}
  .muted{color:#777}
  .mini{font-size:.8rem;line-height:1.3}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  input[type="checkbox"]{width:20px;height:20px}
  @media (max-width:600px){
    .inputs{grid-template-columns:1fr}
    thead th{top:110px}
    .btn{padding:10px 12px}
  }
</style>
</head>
<body>

  <!-- الشريط العلوي -->
  <div class="topbar">
    <div class="wrap">
      <button id="btnClear" class="btn alt small">مسح المحلي</button>
      <button id="btnImport" class="btn alt small">استيراد (CSV)</button>
      <button id="btnExport" class="btn alt small">تصدير (CSV)</button>
      <div class="brand">
        <span class="badge">B</span>
        <span>bonkaim</span>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- النموذج -->
    <div class="card" style="padding:14px">
      <div class="inputs">
        <div class="field">
          <label class="muted">التاريخ</label>
          <input id="inDate" type="date" />
        </div>
        <div class="field">
          <label class="muted">عدد الثنين</label>
          <input id="inCount" type="number" min="0" inputmode="numeric" placeholder="مثال: 100" />
        </div>
        <div class="field">
          <label class="muted">سعر الثنين (ريال)</label>
          <input id="inPrice" type="number" min="0" step="0.01" inputmode="decimal" placeholder="مثال: 25" />
        </div>
        <div class="field">
          <label class="muted">حراج (مدفوع؟)</label>
          <input id="inHarajPaid" type="checkbox" />
        </div>
        <div class="field">
          <label class="muted">أجرة عامل (مدفوعة؟)</label>
          <input id="inWorkerPaid" type="checkbox" checked />
        </div>
      </div>

      <div class="row">
        <button id="btnAdd" class="btn">إضافة +</button>
        <div class="hint">.Google Sheets مع يتزامن + يحفظ محليًا — 1% = الحراج — الأجرة = 2 ريال × عدد الثنين</div>
      </div>
    </div>

    <!-- الجدول -->
    <div class="table-wrap card">
      <table id="tbl">
        <thead>
          <tr>
            <th class="actions">إجراءات</th>
            <th>حراج</th>
            <th>أجرة عامل</th>
            <th class="col-net">صافي الربح</th>
            <th class="col-worker">أجر العامل (2/ثنين)</th>
            <th class="col-fee">حراج 1%</th>
            <th class="col-total">الإجمالي</th>
            <th class="col-price">سعر الثنين</th>
            <th class="col-count">عدد الثنين</th>
            <th class="col-date">التاريخ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td class="actions mini">يحفظ تلقائيًا</td>
            <td></td><td></td>
            <td id="sumNet">0.00</td>
            <td id="sumWorker">0.00</td>
            <td id="sumFee">0.00</td>
            <td id="sumTotal">0.00</td>
            <td id="avgPrice">0.00<br><span class="mini muted">(متوسط)</span></td>
            <td id="sumCount">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>

  <!-- ملف استيراد CSV (مخفي) -->
  <input id="fileCSV" type="file" accept=".csv" style="display:none" />

<script>
(function(){
  const KEY = 'bonkaimRecords.v1';   // مفتاح التخزين المحلي
  let data = load() || [];            // المصفوفة الرئيسية

  // عناصر الصفحة
  const inDate       = document.getElementById('inDate');
  const inCount      = document.getElementById('inCount');
  const inPrice      = document.getElementById('inPrice');
  const inHarajPaid  = document.getElementById('inHarajPaid');
  const inWorkerPaid = document.getElementById('inWorkerPaid');

  const btnAdd    = document.getElementById('btnAdd');
  const btnClear  = document.getElementById('btnClear');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const fileCSV   = document.getElementById('fileCSV');

  const tbody = document.getElementById('tbody');

  // تاريخ اليوم افتراضي
  inDate.value = new Date().toISOString().slice(0,10);

  // حساب صف
  function calcRow(count, price){
    const total  = round2(count * price);
    const fee    = round2(total * 0.01);
    const worker = round2(count * 2);
    const net    = round2(total - fee - worker);
    return { total, fee, worker, net };
  }
  function round2(n){ return Math.round((Number(n)||0) * 100) / 100 }

  // حفظ/قراءة
  function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }
  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }
    catch(_){ return []; }
  }

  // رسم الجدول
  function render(){
    tbody.innerHTML = '';
    let sumCount=0, sumTotal=0, sumFee=0, sumWorker=0, sumNet=0, sumPrice=0;

    data.forEach((r,idx)=>{
      const tr = document.createElement('tr');

      const tdAct = td();
      const del = button('حذف','trash',()=>{ data.splice(idx,1); save(); render(); });
      tdAct.append(del);

      const tdHaraj = td(); tdHaraj.append(pill(r.harajPaid));
      const tdWpaid = td(); tdWpaid.append(pill(r.workerPaid));

      const tdNet    = td(r.net.toFixed(2));    tdNet.className='col-net';
      const tdWorker = td(r.worker.toFixed(2)); tdWorker.className='col-worker';
      const tdFee    = td(r.fee.toFixed(2));    tdFee.className='col-fee';
      const tdTotal  = td(r.total.toFixed(2));  tdTotal.className='col-total';
      const tdPrice  = td(r.price.toFixed(2));  tdPrice.className='col-price';
      const tdCount  = td(String(r.count));     tdCount.className='col-count';
      const tdDate   = td(r.date);              tdDate.className='col-date';

      tr.append(tdAct, tdHaraj, tdWpaid, tdNet, tdWorker, tdFee, tdTotal, tdPrice, tdCount, tdDate);
      tbody.append(tr);

      sumCount  += r.count;
      sumTotal  += r.total;
      sumFee    += r.fee;
      sumWorker += r.worker;
      sumNet    += r.net;
      sumPrice  += r.price;
    });

    // مجاميع
    document.getElementById('sumCount').textContent  = sumCount;
    document.getElementById('avgPrice').firstChild.nodeValue = data.length? (sumPrice/data.length).toFixed(2):'0.00';
    document.getElementById('sumTotal').textContent  = sumTotal.toFixed(2);
    document.getElementById('sumFee').textContent    = sumFee.toFixed(2);
    document.getElementById('sumWorker').textContent = sumWorker.toFixed(2);
    document.getElementById('sumNet').textContent    = sumNet.toFixed(2);
  }

  function td(txt=''){ const d=document.createElement('td'); if(txt) d.textContent=txt; return d; }
  function button(txt, cls, fn){
    const b=document.createElement('button'); b.textContent=txt; b.className=cls==='trash'?'trash':'btn small'; b.onclick=fn; return b;
  }
  function pill(state){ const s=document.createElement('span'); s.className=state?'pill-ok':'pill-no'; return s; }

  // إضافة
  btnAdd.onclick = ()=>{
    const date  = inDate.value || new Date().toISOString().slice(0,10);
    const count = Number(inCount.value || 0);
    const price = Number(inPrice.value || 0);
    const {total,fee,worker,net} = calcRow(count, price);

    const row = {
      id: String(Date.now()),
      date, count, price,
      total, fee, worker, net,
      harajPaid: !!inHarajPaid.checked,
      workerPaid: !!inWorkerPaid.checked
    };
    data.push(row);
    save(); render();

    // تفريغ خفيف (اختياري)
    inCount.value=''; inPrice.value='';
  };

  // مسح المحلي
  btnClear.onclick = ()=>{
    if(confirm('متأكد تمسح البيانات المحلية؟')){ data=[]; save(); render(); }
  };

  // تصدير CSV
  btnExport.onclick = ()=>{
    const headers = ['id','date','count','price','total','fee','worker','net','harajPaid','workerPaid'];
    const lines = [headers.join(',')];
    data.forEach(r=>{
      lines.push([
        r.id, r.date, r.count, r.price, r.total, r.fee, r.worker, r.net,
        r.harajPaid? 'TRUE':'FALSE',
        r.workerPaid? 'TRUE':'FALSE'
      ].join(','));
    });
    const blob = new Blob([lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'bonkaim.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // استيراد CSV
  btnImport.onclick = ()=> fileCSV.click();
  fileCSV.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    const rows = txt.split(/\r?\n/).filter(Boolean).map(r=>r.split(','));
    const hdr = rows.shift().map(h=>h.trim().toLowerCase());
    const idx = name => hdr.indexOf(name);

    const next = [];
    rows.forEach(arr=>{
      const rec = {
        id: arr[idx('id')] || String(Date.now()+Math.random()),
        date: arr[idx('date')] || new Date().toISOString().slice(0,10),
        count: Number(arr[idx('count')]||0),
        price: Number(arr[idx('price')]||0),
        total: Number(arr[idx('total')]||0),
        fee: Number(arr[idx('fee')]||0),
        worker: Number(arr[idx('worker')]||0),
        net: Number(arr[idx('net')]||0),
        harajPaid: String(arr[idx('harajpaid')]||'').toUpperCase()==='TRUE',
        workerPaid: String(arr[idx('workerpaid')]||'').toUpperCase()==='TRUE'
      };
      // لو الأرقام غير محسوبة في CSV نحسبها
      const fix = calcRow(rec.count, rec.price);
      if(!rec.total && (rec.count||rec.price)) Object.assign(rec, fix);
      next.push(rec);
    });

    data = next;
    save(); render();
    fileCSV.value='';
    alert('تم الاستيراد من CSV بنجاح.');
  };

  // أول رسم
  render();
})();
</script>
</body>
</html>
