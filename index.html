<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>bonkaim — برنامج بيع البونيكام</title>
<meta name="theme-color" content="#FFD400"/>
<style>
  :root{
    --ink:#0f0f0f; --muted:#666; --bg:#f7f7f8; --card:#fff;
    --gold:#ffd400; --border:#000;
    --c1:#fff3cd; --c2:#e8f3e2; --c3:#e7f0fb; --c4:#ffe9b6;
    --c5:#f3e0e7; --c6:#e6ecfa; --c7:#e7f4e1;
    --ok:#1e7d32; --bad:#b00020; --okbg:#dcf7e2; --badbg:#ffe1e1;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic","Helvetica Neue",Arial,sans-serif}
  header{background:var(--gold); border-bottom:2px solid var(--border); padding:10px 14px; display:flex; align-items:center; justify-content:space-between; gap:8px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .badge{width:34px;height:34px;border-radius:8px;background:#111;color:#ffd400;display:grid;place-items:center}
  .wrap{max-width:1100px;margin:auto;padding:12px}
  .toolrow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  button{padding:10px 14px;border:1.8px solid var(--border);border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .ghost{background:#fff;color:#111}
  .hint{font-size:12px;color:var(--muted)}
  .inputs{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:8px}
  label{font-size:12px;color:var(--muted);margin:0 0 4px;display:block}
  input[type="number"],input[type="date"]{width:100%;padding:10px;border:1.8px solid #bbb;border-radius:10px;background:#fff;font-size:16px}
  input[type="checkbox"]{width:22px;height:22px}
  .table-wrap{background:#fff;border:2px solid var(--border);border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#fafafa;border-bottom:2px solid var(--border);padding:10px;text-align:center}
  tbody td,tfoot td{padding:10px;border-top:1.5px solid var(--border);border-right:1.5px solid var(--border);text-align:center}
  tbody tr:nth-child(even){background:#fcfcfc}
  .num{font-variant-numeric:tabular-nums}
  .c-total{background:var(--c1)} .c-price{background:var(--c2)} .c-count{background:var(--c3)}
  .c-date{background:var(--c4)} .c-fee{background:var(--c5)} .c-worker{background:var(--c6)} .c-net{background:var(--c7)}
  .rowbtn{background:#111;color:#fff;border:1.8px solid var(--border);padding:6px 10px;border-radius:10px}
  .flag{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border:2px solid var(--border);border-radius:6px;font-weight:800}
  .ok{background:var(--okbg);color:var(--ok)} .no{background:var(--badbg);color:var(--bad)}
  .pending{font-size:12px;opacity:.8}
  tfoot td{background:#f1f1f1;font-weight:700}
  .settings{display:flex;align-items:center;gap:8px}
  .urlbox{min-width:260px;padding:8px;border:1.8px solid #bbb;border-radius:10px}
  @media (max-width:900px){.inputs{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header>
  <div class="brand"><span class="badge">B</span><span>bonkaim</span></div>
  <div class="settings">
    <input id="gsUrl" class="urlbox" placeholder="ألصق رابط سكربت Apps Script هنا ثم حفظ" />
    <button id="btnSaveUrl" class="ghost">حفظ الرابط</button>
    <button id="btnPull" class="ghost">تحديث من الشيت</button>
    <button id="btnClearLocal" class="ghost">مسح المحلي</button>
  </div>
</header>

<div class="wrap">
  <div class="toolrow">
    <span id="syncStat" class="hint">مستعد. يحفظ محليًا + يزامن مع Google Sheets عند توفر الشبكة.</span>
  </div>

  <div class="card">
    <div class="inputs">
      <div><label>عدد الفلين</label><input id="count" type="number" inputmode="numeric" min="0" step="1" placeholder="مثال: 100"></div>
      <div><label>التاريخ</label><input id="date" type="date"></div>
      <div><label>سعر الفلين (ريال)</label><input id="price" type="number" inputmode="decimal" min="0" step="0.01" placeholder="مثال: 25"></div>
      <div><label>حراج (مدفوع؟)</label><input id="harajPaid" type="checkbox"></div>
      <div><label>أجرة عامل (مدفوعة؟)</label><input id="workerPaid" type="checkbox"></div>
      <div style="display:flex;align-items:end"><button id="btnAdd">+ إضافة</button></div>
    </div>
    <div class="hint">الأجرة = <b>2 ريال</b> × عدد الفلين — الحراج = <b>1%</b> — يعمل بدون إنترنت ويزامن تلقائيًا عند الشبكة.</div>
  </div>

  <div class="table-wrap" style="margin-top:12px">
    <table id="tbl">
      <thead>
        <tr>
          <th>إجراءات</th><th>حراج</th><th>أجرة عامل</th>
          <th class="c-net">صافي الربح</th><th class="c-worker">أجر العامل (2/فلين)</th>
          <th class="c-fee">حراج %1</th><th class="c-total">الإجمالي</th>
          <th class="c-price">سعر الفلين</th><th class="c-count">عدد الفلين</th><th class="c-date">التاريخ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>الإجماليات</td><td></td><td></td>
          <td class="num" id="tNet">0.00</td><td class="num" id="tWorker">0.00</td>
          <td class="num" id="tFee">0.00</td><td class="num" id="tTotal">0.00</td>
          <td class="num" id="tAvgPrice">0.00 (متوسط)</td><td class="num" id="tCount">0</td>
          <td style="font-size:12px">محلي + مزامنة بالشيت</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ========== الإعداد ========== */

/* احفظ هنا “مبدئيًا” رابط تطبيق الويب (Apps Script) — تقدر تغيّره من خانة الإعداد أعلى الصفحة */
const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby326PEkBLafZpUnY_fcZ466O8ynURdNpTDyyXAczd8JyENGks5KPtCn7fHMKkX4aIZzQ/exec';
const LS_URL   = 'bonkaim_gs_url_v1';
const LS_ROWS  = 'bonkaim_rows_v3';
const LS_OUTBOX= 'bonkaim_outbox_v1';

function gsURL(){ return localStorage.getItem(LS_URL) || DEFAULT_SCRIPT_URL; }
function setGsURL(u){ localStorage.setItem(LS_URL, u.trim()); $('gsUrl').value = gsURL(); }

const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ========== بيانات ========== */
let rows = [];         // السجلات المحلية
let outbox = [];       // طابور السجلات المطلوب رفعها (id فقط)

/* ========== أدوات ========== */
function todayISO(){ const d=new Date(); const t=new Date(d.getTime()-d.getTimezoneOffset()*60000); return t.toISOString().slice(0,10); }
$('date').value = todayISO();

function load(){
  rows   = JSON.parse(localStorage.getItem(LS_ROWS)||'[]');
  outbox = JSON.parse(localStorage.getItem(LS_OUTBOX)||'[]');
}
function save(){
  localStorage.setItem(LS_ROWS, JSON.stringify(rows));
  localStorage.setItem(LS_OUTBOX, JSON.stringify(outbox));
}
function status(s){ $('syncStat').textContent=s; }

/* حسابات الصف */
function compute(r){
  const c=+r.count||0, p=+r.price||0;
  const total=c*p;
  const fee=+(total*0.01).toFixed(2);
  const worker=+(c*2).toFixed(2);
  const net=+(total-fee-worker).toFixed(2);
  r.total=+total.toFixed(2); r.fee=fee; r.worker=worker; r.net=net;
  return r;
}
function Flag(tf){ return `<span class="flag ${tf?'ok':'no'}">${tf?'✓':'✗'}</span>`; }

/* رسم الجدول */
function render(){
  const tb=$('tbody'); tb.innerHTML='';
  // لا نمس الترتيب الزمني المتزايد
  rows.sort((a,b)=> a.date.localeCompare(b.date) || a.id.localeCompare(b.id));
  for(const r of rows){
    const pending = outbox.includes(r.id);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <button class="rowbtn" onclick="delRow('${r.id}')">حذف</button>
        ${pending? `<div class="pending">بانتظار الرفع ⏳</div>`:''}
      </td>
      <td>${Flag(!!r.harajPaid)}</td>
      <td>${Flag(!!r.workerPaid)}</td>
      <td class="num c-net">${(r.net??0).toFixed(2)}</td>
      <td class="num c-worker">${(r.worker??0).toFixed(2)}</td>
      <td class="num c-fee">${(r.fee??0).toFixed(2)}</td>
      <td class="num c-total">${(r.total??0).toFixed(2)}</td>
      <td class="num c-price">${(+r.price||0).toFixed(2)}</td>
      <td class="num c-count">${(+r.count||0).toFixed(0)}</td>
      <td class="c-date">${r.date||''}</td>`;
    tb.appendChild(tr);
  }
  const sum=k=>rows.reduce((a,c)=>a+Number(c[k]||0),0);
  const avg=rows.length? rows.reduce((a,c)=>a+Number(c.price||0),0)/rows.length : 0;
  $('tCount').textContent = sum('count').toFixed(0);
  $('tTotal').textContent = sum('total').toFixed(2);
  $('tFee').textContent   = sum('fee').toFixed(2);
  $('tWorker').textContent= sum('worker').toFixed(2);
  $('tNet').textContent   = sum('net').toFixed(2);
  $('tAvgPrice').textContent = avg.toFixed(2)+' (متوسط)';
}

function delRow(id){
  // حذف محلي فقط (الزر واحد وواضح)
  rows = rows.filter(x=>x.id!==id);
  outbox = outbox.filter(x=>x!==id);
  save(); render(); status('تم حذف السجل محليًا. (لن يحذف من الشيت)');
}

/* ========== شبكة ========== */
async function postJSON(url, bodyObj){
  // Apps Script غالبًا يرجّع HTML فيه JSON — نتعامل معه كـ نص ثم نعمل JSON.parse
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
    body: JSON.stringify(bodyObj)
  });
  const txt = await res.text();
  try{ return JSON.parse(txt); } catch{ return {ok:res.ok, raw:txt}; }
}

async function sendRow(row){
  const url = gsURL();
  const payload = {
    id: row.id, date: row.date, count: row.count, price: row.price,
    total: row.total, fee: row.fee, worker: row.worker, net: row.net,
    harajPaid: row.harajPaid ? 'TRUE' : 'FALSE',
    workerPaid: row.workerPaid ? 'TRUE' : 'FALSE'
  };
  const r = await postJSON(url+'?action=add', payload);
  if(!r || r.ok!==true) throw new Error('upload failed');
}

async function addRow(){
  const date=$('date').value||todayISO();
  const count=+$('count').value||0;
  const price=+$('price').value||0;
  const harajPaid=$('harajPaid').checked;
  const workerPaid=$('workerPaid').checked;

  const row=compute({id: Date.now()+''+Math.random().toString(16).slice(2), date,count,price, harajPaid, workerPaid});
  rows.push(row);
  outbox.push(row.id);
  save(); render();

  // نحاول رفعه الآن؛ لو فشل يبقى في outbox
  try{
    status('جارِ الرفع للشيت…'); await sendRow(row);
    outbox = outbox.filter(x=>x!==row.id); save(); render();
    status('تم الرفع للشيت ✔️');
  }catch(e){
    status('فشل الرفع الآن — محفوظ محليًا. سيُرسل تلقائيًا عند الشبكة.');
    alert('فشل الرفع الآن، السجل محفوظ محليًا.\nاضغط "تحديث من الشيت" لاحقًا بعد توفر الشبكة.');
  }

  $('count').value=''; $('price').value='';
}

async function pushOutbox(){
  // نحاول رفع كل المتراكم
  if(outbox.length===0) return;
  const url = gsURL();
  status('رفع السجلات المعلقة…');
  for(const id of [...outbox]){ // نسخة
    const row = rows.find(r=>r.id===id);
    if(!row){ outbox = outbox.filter(x=>x!==id); save(); continue; }
    try{ await sendRow(row); outbox = outbox.filter(x=>x!==id); save(); render(); }
    catch(_){ /* نوقف إذا الشبكة سيئة */ break; }
  }
}

async function pull(){
  try{
    await pushOutbox(); // أولًا نحاول رفع المعلّق
    status('جارِ التحديث من الشيت…');

    // نضيف باراميتر t لتفادي كاش سفاري
    const r = await fetch(gsURL()+'?action=get&t='+(Date.now()), {cache:'no-store'});
    const txt = await r.text();
    let j={ok:false,data:[]}; try{ j=JSON.parse(txt);}catch(_){}
    if(!j || j.ok!==true) throw new Error('bad get');

    const remote = Array.isArray(j.data)? j.data : [];
    // نضيف الجديد فقط، ولا نمس المحلي (لا مسح للمحلي)
    const localIDs = new Set(rows.map(x=>x.id));
    let added=0;
    for(const o of remote){
      if(!o || !o.id) continue;
      if(!localIDs.has(String(o.id))){
        const r = compute({
          id:String(o.id), date:o.date||'', count:+o.count||0, price:+o.price||0,
          total:+o.total||0, fee:+o.fee||0, worker:+o.worker||0, net:+o.net||0,
          harajPaid: (String(o.harajPaid).toUpperCase()==='TRUE' || String(o.harajPaid)==='تم'),
          workerPaid:(String(o.workerPaid ).toUpperCase()==='TRUE' || String(o.workerPaid )==='تم')
        });
        rows.push(r); added++;
      }
    }
    save(); render();
    status(added? ('تم التحديث من الشيت ✔️ أضيف '+added+' سجل'): 'تم التحديث — لا جديد من الشيت.');
  }catch(e){
    status('تعذّر الجلب من الشيت. تأكد من رابط السكربت والنشر Anyone.');
    alert('تعذّر الجلب من الشيت.\n- تأكد أن رابط السكربت صحيح ومختوم بـ /exec\n- وأن النشر "أي شخص".');
  }
}

/* ========== ربط واجهة ========== */
$('btnAdd').addEventListener('click', addRow);
$('btnPull').addEventListener('click', pull);
$('btnClearLocal').addEventListener('click', ()=>{
  if(confirm('متأكد تمسح النسخة المحلية فقط؟ لن يُحذف من الشيت.')){
    rows=[]; outbox=[]; save(); render(); status('تم مسح المحلي.');
  }
});
$('btnSaveUrl').addEventListener('click', ()=>{
  const val = $('gsUrl').value.trim();
  if(!val){ alert('ألصق رابط السكربت أولًا'); return; }
  setGsURL(val);
  status('تم حفظ رابط السكربت.'); 
});

function init(){
  $('gsUrl').value = gsURL();
  load(); render();
  // نحاول فور الفتح نرفع أي معلقات
  pushOutbox();
}
init();
</script>
</body>
</html>
