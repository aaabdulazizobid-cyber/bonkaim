<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>برنامج بيع البونيكام — نسخة سريعة</title>
<meta name="theme-color" content="#FFD700"/>

<style>
  :root{
    --ink:#0f0f0f; --muted:#666; --bg:#f7f7f8; --card:#fff;
    --gold:#ffd400; --border:#000;
    --c1:#f7f0e2; /* الإجمالي */
    --c2:#e8f3e2; /* سعر */
    --c3:#e7f0fb; /* عدد */
    --c4:#ffe9b6; /* التاريخ */
    --c5:#f3e0e7; /* حراج% */
    --c6:#e6ecfa; /* أجر العامل (رقمي) */
    --c7:#e7f4e1; /* صافي */
    --ok:#2e7d32; --bad:#b00020;
    --ok-bg:#dbf2df; --bad-bg:#f8d7da;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic","Helvetica Neue",Arial,sans-serif}
  header{background:var(--gold); border-bottom:2px solid var(--border); padding:10px 16px; display:flex; align-items:center; gap:10px}
  .logo{display:inline-flex; align-items:center; gap:10px; font-weight:800; font-size:18px}
  .logo-badge{width:34px;height:34px;border-radius:8px;background:#111;color:#ffd400;display:inline-grid;place-items:center;font-weight:800}
  .wrap{max-width:1100px;margin:auto;padding:14px}
  .toolrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  button{padding:10px 14px;border:1.8px solid var(--border);border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .ghost{background:#fff;color:#111}
  .inputs{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:8px}
  label{font-size:12px;color:var(--muted);margin:0 0 5px;display:block}
  input[type="number"],input[type="date"]{
    width:100%;padding:10px;border:1.8px solid #bbb;border-radius:10px;background:#fff;font-size:16px
  }
  .table-wrap{background:#fff;border:2px solid var(--border);border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#fafafa;border-bottom:2px solid var(--border);padding:10px;text-align:center}
  tbody td,tfoot td{padding:10px;border-top:1.5px solid var(--border);border-right:1.5px solid var(--border);text-align:center}
  tbody tr:nth-child(even){background:#fcfcfc}
  .num{font-variant-numeric:tabular-nums}
  .c-total{background:var(--c1)}
  .c-price{background:var(--c2)}
  .c-count{background:var(--c3)}
  .c-date{background:var(--c4)}
  .c-fee{background:var(--c5)}
  .c-worker{background:var(--c6)}
  .c-net{background:var(--c7)}
  .rowbtn{background:#111;color:#fff;border:1.8px solid var(--border);padding:6px 10px;border-radius:10px}
  tfoot td{background:#f1f1f1;font-weight:700}

  /* شارات مربعة لحراج/أجرة عامل */
  .flagbox {display:inline-flex; align-items:center; justify-content:center; width:34px;height:34px;
            border:2px solid var(--border); border-radius:6px; font-weight:800; font-size:18px;
            cursor:pointer; user-select:none;}
  .flag-ok{background:var(--ok-bg); color:var(--ok);}
  .flag-no{background:var(--bad-bg); color:var(--bad);}

  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  @media (max-width:900px){
    .inputs{grid-template-columns:1fr 1fr}
  }

  /* وضع أسود */
  body.dark{
    --ink:#f1f5f9; --muted:#cbd5e1; --bg:#0b0b0b; --card:#111;
    --gold:#111; --border:#3f3f46;
    --c1:#2a2618; --c2:#1f2a1f; --c3:#1a2431; --c4:#2a2516; --c5:#2a1e25; --c6:#1f2433; --c7:#1d2a1b;
    --ok-bg:#16361a; --bad-bg:#3a1d21;
  }
  body.dark header{background:#111; border-bottom-color:#3f3f46}
  body.dark .ghost{background:#222;color:#eee;border-color:#3f3f46}
  body.dark input[type="number"], body.dark input[type="date"]{background:#111;color:#eee;border-color:#3f3f46}
  body.dark .table-wrap{background:#111;border-color:#3f3f46}
  body.dark thead th{background:#1a1a1a;border-bottom-color:#3f3f46}
  body.dark tbody tr:nth-child(even){background:#101010}
  body.dark tfoot td{background:#151515}
</style>
</head>
<body>
<header>
  <div class="logo">
    <span class="logo-badge">B</span>
    <span>bonkaim</span>
  </div>
</header>

<div class="wrap">

  <div class="toolrow">
    <button class="ghost" id="btnPull">تحديث من الشيت</button>
    <button class="ghost" id="btnClearLocal">مسح المحلي</button>
    <!-- ظاهر: تصدير/استيراد -->
    <button class="ghost" id="btnExport">تصدير نسخة</button>
    <button class="ghost" id="btnImport">استيراد نسخة</button>
    <!-- خيار الوضع الأسود -->
    <button class="ghost" id="btnTheme">الوضع الأسود</button>
    <span id="syncStat" class="hint">جاهز.</span>
  </div>

  <!-- مُدخل ملف خفي للاستيراد -->
  <input id="fileImport" type="file" accept="application/json" style="display:none"/>

  <div class="card">
    <div class="inputs">
      <div>
        <label>عدد الفلين</label>
        <input id="count" type="number" inputmode="numeric" min="0" step="1" placeholder="مثال: 100"/>
      </div>
      <div>
        <label>التاريخ</label>
        <input id="date" type="date"/>
      </div>
      <div>
        <label>سعر الفلين (ريال)</label>
        <input id="price" type="number" inputmode="decimal" min="0" step="0.01" placeholder="مثال: 25"/>
      </div>
      <div>
        <label>حراج (مدفوع؟)</label>
        <input id="harajPaid" type="checkbox"/>
      </div>
      <div>
        <label>أجرة عامل (مدفوعة؟)</label>
        <input id="workerPaid" type="checkbox"/>
      </div>
      <div style="display:flex;align-items:end">
        <button id="btnAdd">+ إضافة</button>
      </div>
    </div>
    <div class="hint">الأجرة = <b>2 ريال</b> × عدد الفلين — الحراج = <b>1%</b> من الإجمالي — يحفظ محليًا + يتزامن مع Google Sheets عند توافر الشبكة.</div>
  </div>

  <div class="table-wrap" style="margin-top:12px">
    <table id="tbl">
      <thead>
        <tr>
          <th>إجراءات</th>
          <th>حراج</th>
          <th>أجرة عامل</th>
          <th class="c-net">صافي الربح</th>
          <th class="c-worker">أجر العامل (فلين/2)</th>
          <th class="c-fee">حراج %1</th>
          <th class="c-total">الإجمالي</th>
          <th class="c-price">سعر الفلين</th>
          <th class="c-count">عدد الفلين</th>
          <th class="c-date">التاريخ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <td>الإجماليات</td>
          <td></td>
          <td></td>
          <td class="num" id="tNet">0.00</td>
          <td class="num" id="tWorker">0.00</td>
          <td class="num" id="tFee">0.00</td>
          <td class="num" id="tTotal">0.00</td>
          <td class="num" id="tAvgPrice">0.00 (متوسط)</td>
          <td class="num" id="tCount">0</td>
          <td style="font-size:12px">يحفظ تلقائيًا + مزامنة بالشيت</td>
        </tr>
        <tr>
          <td colspan="5" class="num">أجرة العامل — مدفوع: <span id="tWorkerPaid">0.00</span> | متبقي: <span id="tWorkerDue">0.00</span></td>
          <td colspan="5" class="num">حراج — مدفوع: <span id="tFeePaid">0.00</span> | متبقي: <span id="tFeeDue">0.00</span></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ---------------- إعداد المزامنة (اختياري) ---------------- */
const GET_URL = ''; // ضع رابط جلب الصفوف (إن رغبت)
const ADD_URL = ''; // ضع رابط الإضافة (إن رغبت)

const LS_KEY='bonikam_sync_v1';
let rows=[];

function todayISO(){
  const d=new Date();
  const t=new Date(d.getTime()-d.getTimezoneOffset()*60000);
  return t.toISOString().slice(0,10);
}
document.getElementById('date').value=todayISO();

function load(){ rows=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); }
function status(s){ document.getElementById('syncStat').textContent=s; }

function compute(r){
  const c=+r.count||0, p=+r.price||0;
  const total=c*p;
  const fee=+(total*0.01).toFixed(2);
  const worker=+(c*2).toFixed(2);
  const net=+(total-fee-worker).toFixed(2);
  r.total=+total.toFixed(2); r.fee=fee; r.worker=worker; r.net=net; 
  return r;
}

/* جعل شارات ✓/✗ قابلة للتبديل */
function flagBox(tf, id, field){
  const cls = tf ? 'flag-ok' : 'flag-no';
  const ch  = tf ? '✓' : '✗';
  return `<span class="flagbox ${cls}" title="اضغط للتبديل" onclick="toggleFlag('${id}','${field}')">${ch}</span>`;
}
function toggleFlag(id, field){
  const r = rows.find(x=>x.id===id);
  if(!r) return;
  r[field] = !r[field];
  save(); render();
  status('تم التعديل وحُفظ محليًا.');
}

function render(){
  const tb=document.getElementById('tbody'); tb.innerHTML='';
  rows.sort((a,b)=> a.date.localeCompare(b.date));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><button class="rowbtn" onclick="delRow('${r.id}')">حذف</button></td>
      <td>${flagBox(!!r.harajPaid, r.id, 'harajPaid')}</td>
      <td>${flagBox(!!r.workerPaid, r.id, 'workerPaid')}</td>
      <td class="num c-net">${(r.net??0).toFixed(2)}</td>
      <td class="num c-worker">${(r.worker??0).toFixed(2)}</td>
      <td class="num c-fee">${(r.fee??0).toFixed(2)}</td>
      <td class="num c-total">${(r.total??0).toFixed(2)}</td>
      <td class="num c-price">${r.price}</td>
      <td class="num c-count">${r.count}</td>
      <td class="c-date">${r.date}</td>
    `;
    tb.appendChild(tr);
  }
  const sum=k=>rows.reduce((a,c)=>a+Number(c[k]||0),0);
  const avgPrice=rows.length? rows.reduce((a,c)=>a+Number(c.price||0),0)/rows.length : 0;

  document.getElementById('tCount').textContent = sum('count').toFixed(0);
  document.getElementById('tTotal').textContent = sum('total').toFixed(2);
  document.getElementById('tFee').textContent   = sum('fee').toFixed(2);
  document.getElementById('tWorker').textContent= sum('worker').toFixed(2);
  document.getElementById('tNet').textContent   = sum('net').toFixed(2);
  document.getElementById('tAvgPrice').textContent = avgPrice.toFixed(2)+' (متوسط)';

  const workerPaid = rows.reduce((a,r)=> a + (r.workerPaid ? Number(r.worker||0):0), 0);
  const workerDue  = rows.reduce((a,r)=> a + (!r.workerPaid ? Number(r.worker||0):0), 0);
  const feePaid    = rows.reduce((a,r)=> a + (r.harajPaid ? Number(r.fee||0):0), 0);
  const feeDue     = rows.reduce((a,r)=> a + (!r.harajPaid ? Number(r.fee||0):0), 0);

  const wp=document.getElementById('tWorkerPaid');
  const wd=document.getElementById('tWorkerDue');
  const fp=document.getElementById('tFeePaid');
  const fd=document.getElementById('tFeeDue');
  if(wp) wp.textContent = workerPaid.toFixed(2);
  if(wd) wd.textContent = workerDue.toFixed(2);
  if(fp) fp.textContent = feePaid.toFixed(2);
  if(fd) fd.textContent = feeDue.toFixed(2);
}

function delRow(id){
  rows=rows.filter(x=>x.id!==id);
  save(); render(); status('حُذف محليًا (الشيت لم يتغيّر).');
}

async function addRow(){
  const date=document.getElementById('date').value||todayISO();
  const count=+document.getElementById('count').value||0;
  const price=+document.getElementById('price').value||0;
  const harajPaid=document.getElementById('harajPaid').checked;
  const workerPaid=document.getElementById('workerPaid').checked;
  const row=compute({id: Date.now()+''+Math.random().toString(16).slice(2), date,count,price, harajPaid, workerPaid});
  rows.push(row); save(); render();

  if(!ADD_URL){ status('أُضيف محليًا. (لم يتم الإرسال: لا يوجد ADD_URL)'); resetInputs(); return; }

  try{
    status('جارِ الإرسال للشيت...');
    const res=await fetch(ADD_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[{
      id:row.id,date:row.date,count:row.count,price:row.price,total:row.total,fee:row.fee,worker:row.worker,net:row.net,
      harajPaid: row.harajPaid?'TRUE':'FALSE',
      workerPaid: row.workerPaid?'TRUE':'FALSE'
    }]})});
    if(!res.ok){
      const t=await res.text();
      status('فشل رفع الصف. محفوظ محليًا.'); alert('تعذّر الإرسال الآن.\n\n'+t);
    }else{
      status('تم الرفع للشيت ✔️');
    }
  }catch(e){
    status('الشيت غير متاح الآن.'); alert('تعذّر الإرسال الآن—محفوظ محليًا.');
  }
  resetInputs();
}

function resetInputs(){
  document.getElementById('count').value='';
  document.getElementById('price').value='';
}

async function pull(){
  if(!GET_URL){ status('تم التحديث محلي فقط (لا يوجد GET_URL).'); return; }
  try{
    status('جارِ التحديث من الشيت...');
    const r=await fetch(GET_URL);
    if(!r.ok) throw new Error('GET failed');
    const j=await r.json();
    const arr=Array.isArray(j.data)? j.data : (Array.isArray(j)? j : []);
    rows = arr.map(o=>compute({
      id: o.id ?? o.ID ?? '',
      date: o.date ?? '',
      count:+o.count||0, price:+o.price||0,
      total:+o.total||0, fee:+o.fee||0, worker:+o.worker||0, net:+o.net||0,
      harajPaid: (o.harajPaid===true||o.harajPaid==='TRUE'||o.harajPaid==='تم'),
      workerPaid:(o.workerPaid===true||o.workerPaid==='TRUE'||o.workerPaid==='تم')
    }));
    save(); render(); status('تم التحديث من الشيت ✔️');
  }catch(e){
    status('تعذّر الجلب من الشيت.'); alert('تأكد من رابط GET/الصلاحيات.');
  }
}

/* ---------------- النسخة الاحتياطية: تصدير/استيراد ---------------- */
function exportBackup(){
  try{
    const payload = {version:1, exportedAt:new Date().toISOString(), rows};
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    const name = `bonkaim-backup-${ts}.json`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    status('تم تنزيل النسخة الاحتياطية.');
  }catch(e){
    alert('تعذر إنشاء النسخة الاحتياطية.'); status('فشل التصدير.');
  }
}

function handleImportFile(e){
  const file = e.target.files && e.target.files[0];
  if(!file){ return; }
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      const arr = Array.isArray(data) ? data : (Array.isArray(data.rows) ? data.rows : null);
      if(!arr) throw new Error('bad');
      if(!confirm('سيتم استبدال البيانات الحالية بالنسخة المستوردة. متابعة؟')){ status('أُلغي الاستيراد.'); return; }
      rows = arr.map(o=>compute({
        id: o.id ?? Date.now()+''+Math.random().toString(16).slice(2),
        date: o.date ?? '',
        count:+o.count||0, price:+o.price||0,
        total:+o.total||0, fee:+o.fee||0, worker:+o.worker||0, net:+o.net||0,
        harajPaid: (o.harajPaid===true||o.harajPaid==='TRUE'||o.harajPaid==='تم'),
        workerPaid:(o.workerPaid===true||o.workerPaid==='TRUE'||o.workerPaid==='تم')
      }));
      save(); render(); status('تم الاستيراد من الملف ✔️');
    }catch(err){
      alert('الملف غير صالح أو تالف.'); status('فشل الاستيراد.');
    }finally{
      e.target.value=''; // يسمح باختيار نفس الملف مرة أخرى
    }
  };
  reader.onerror = () => { alert('حدث خطأ أثناء قراءة الملف.'); status('فشل الاستيراد.'); };
  reader.readAsText(file);
}

document.getElementById('btnAdd').addEventListener('click', addRow);
document.getElementById('btnPull').addEventListener('click', pull);
document.getElementById('btnClearLocal').addEventListener('click', ()=>{
  if(confirm('متأكد تمسح النسخة المحلية فقط؟')){ rows=[]; save(); render(); status('تم مسح المحلي.');}
});

/* ربط أزرار النسخة الاحتياطية */
document.getElementById('btnExport').addEventListener('click', exportBackup);
document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileImport').click());
document.getElementById('fileImport').addEventListener('change', handleImportFile);

/* --------- زر الوضع الأسود (يحفظ التفضيل) --------- */
const THEME_KEY='bonikam_theme';
function applyTheme(){
  const v = localStorage.getItem(THEME_KEY)||'light';
  document.body.classList.toggle('dark', v==='dark');
  const btn = document.getElementById('btnTheme');
  if(btn) btn.textContent = (v==='dark') ? 'الوضع الفاتح' : 'الوضع الأسود';
}
function toggleTheme(){
  const v = localStorage.getItem(THEME_KEY)||'light';
  const nv = (v==='dark')?'light':'dark';
  localStorage.setItem(THEME_KEY, nv);
  applyTheme();
}
document.getElementById('btnTheme').addEventListener('click', toggleTheme);
applyTheme();
/* --------------------------------------------------- */

load(); render();
</script>
</body>
</html>
